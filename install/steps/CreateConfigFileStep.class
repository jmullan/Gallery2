<?php
/*
 * $RCSfile$
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2003 Bharat Mediratta
 * 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

class CreateConfigFileStep extends InstallStep {
    function stepName() {
	return _('Create Config File');
    }

    function loadTemplateData(&$templateData) {
	global $gallery;
	
	$configFilePath = realpath(dirname(__FILE__) . '/../../config.php');
	if (file_exists($configFilePath) && !is_writable($configFilePath)) {
	    $templateData['error'] = _('Unable to write to the <b>config.php</b> configuration file in your <tt>gallery</tt> directory.  Please change its permissions.');
	    $this->setInError(true);
	} else {
	    if (!$out = @fopen($configFilePath, 'w')) {
		$templateData['error'] = 'Unable to create <b>config.php</b> in your <tt>gallery</tt> directory. Make sure that Gallery has write permissions for that directory, or please create a <b>config.php</b> file there and make sure Gallery can write to it.';
		$this->setInError(true);
	    } else {
		$newStoreConfig = $gallery->getConfig('storage.config');
		$in = @fopen(dirname(__FILE__) . '/../config.php-sample', 'r');
		while ($line = fgets($in)) {
		    if (trim($line) == '$gallery->setConfig(\'setup.password\', \'\');') {
			$tmp = addslashes($gallery->getConfig('setup.password'));
			$line = sprintf("\$gallery->setConfig('setup.password', '%s');\n", $tmp);
		    }

		    if (trim($line) == '$gallery->setConfig(\'data.gallery.base\', \'\');') {
			$tmp = addslashes($gallery->getConfig('data.gallery.base'));
			$line = sprintf("\$gallery->setConfig('data.gallery.base', '%s');\n", $tmp);
		    }

		    foreach (array('type', 'hostname', 'database', 'username',
				   'password', 'tablePrefix', 'columnPrefix') as $key) {
			if (preg_match("/^.storeConfig\['$key'\] = '.*';/", $line)) {
			    $newStoreConfig[$key] = addslashes($newStoreConfig[$key]);
			    $line = "\$storeConfig['$key'] = '$newStoreConfig[$key]';\n";
			}
		    }

		    fwrite($out, $line);
		}
		fclose($in);
		fclose($out);
		$this->setComplete(true);
	    }
	}
	
	if ($this->isComplete()) {
	    $templateData['bodyFile'] = 'templates/CreateConfigFileSuccess.html';
	} else {
	    $templateData['bodyFile'] = 'templates/CreateConfigFileFailed.html';
	}
    }
}
?>
