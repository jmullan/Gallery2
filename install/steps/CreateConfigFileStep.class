<?php
/*
 * $RCSfile$
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2004 Bharat Mediratta
 * 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

class CreateConfigFileStep extends InstallStep {
    var $_firstTime;

    function CreateConfigFileStep() {
	$this->_firstTime = true;
    }

    function stepName() {
	return _('Create Config File');
    }

    function loadTemplateData(&$templateData) {
	global $galleryStub;

	$configFilePath = dirname(__FILE__) . '/../../config.php';
	if (file_exists($configFilePath) && !is_writable($configFilePath)) {
	    /* The file exists but we can't write to it */
	    $templateData['error'] = _('Unable to write to the <b>config.php</b> configuration file in your <tt>gallery2</tt> directory.  Please change its permissions.  If you\'re on Unix you can do <i>chmod 666 config.php</i> to fix this.');
	    $this->setInError(true);
	    $templateData['bodyFile'] = 'CreateConfigFileInstructions.html';
	    $templateData['galleryDir'] = basename(dirname(dirname(dirname(__FILE__))));
	} else {
	    if (!$out = @fopen($configFilePath, 'w')) {
		/* Give the user instructions */
		$templateData['bodyFile'] = 'CreateConfigFileInstructions.html';
		$templateData['galleryDir'] = basename(dirname(dirname(dirname(__FILE__))));

		if (!$this->_firstTime) {
		    if (!file_exists($configFilePath)) {
			$templateData['error'] =
			    sprintf(_('The <b>config.php</b> file does not exist in your %s directory'),
				    dirname(dirname(dirname(__FILE__))));
		    }
		}
	    } else {
		$newStoreConfig = $galleryStub->getConfig('storage.config');
		$in = @fopen(dirname(__FILE__) . '/../config.php-template', 'r');
		while ($line = fgets($in, 2000)) {
		    if (trim($line) == '$gallery->setConfig(\'setup.password\', \'\');') {
			$tmp = addslashes($galleryStub->getConfig('setup.password'));
			$line = sprintf("\$gallery->setConfig('setup.password', '%s');\n", $tmp);
		    }

		    if (trim($line) == '$gallery->setConfig(\'data.gallery.base\', \'\');') {
			$tmp = addslashes($galleryStub->getConfig('data.gallery.base'));
			$line = sprintf("\$gallery->setConfig('data.gallery.base', '%s');\n", $tmp);
		    }

		    foreach (array('type', 'hostname', 'database', 'username',
				   'password', 'tablePrefix', 'columnPrefix') as $key) {
			if (preg_match("/^.storeConfig\['$key'\] = '.*';/", $line)) {
			    $newStoreConfig[$key] = addslashes($newStoreConfig[$key]);
			    $line = "\$storeConfig['$key'] = '$newStoreConfig[$key]';\n";
			}
		    }

		    fwrite($out, $line);
		}
		fclose($in);
		fclose($out);
		$this->setComplete(true);
		$templateData['bodyFile'] = 'CreateConfigFileSuccess.html';
	    }
	}
	$this->_firstTime = false;
    }
}
?>
