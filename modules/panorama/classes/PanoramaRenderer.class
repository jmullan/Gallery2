<?php
/*
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2006 Bharat Mediratta
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA  02110-1301, USA.
 */
/**
 * @version $Revision$ $Date$
 * @package Panorama
 * @author Alan Harder <alan.harder@sun.com>
 */

GalleryCoreApi::requireOnce('modules/core/classes/GalleryRenderer.class');

/**
 * A GalleryRenderer that uses the panorama applet
 *
 * @package Panorama
 * @subpackage Classes
 */
class PanoramaRenderer extends GalleryRenderer {

    /**
     * @see GalleryRenderer::canBeViewedInline
     */
    function canBeViewedInline($item) {
	return true;
    }

    /**
     * @see GalleryRenderer::render
     */
    function render($format, $entity, $item, $params) {
	global $gallery;

	list ($ret, $viewWidth) = GalleryCoreApi::getPluginParameter('module', 'panorama', 'width');
	if ($ret) {
	    return $ret;
	}

	if (!empty($params['forceRawImage']) || $entity->getWidth() < $viewWidth) {
	    /* Return nothing so that we fall back to the default renderer */
	    return null;
	}

	switch($format) {
	case 'HTML':
	    $urlGenerator =& $gallery->getUrlGenerator();
	    $src = $urlGenerator->generateUrl(
		array('view' => 'core.DownloadItem', 'itemId' => $entity->getId(),
		      'serialNumber' => $entity->getSerialNumber()),
		array('forceFullUrl' => true, 'forceSessionId' => true));

	    list ($width, $height) = array($entity->getWidth(), $entity->getHeight());
	    $baseUrl = GalleryUtilities::convertPathToUrl(
		dirname(dirname(__FILE__)), array('forceFullUrl' => true));

	    return sprintf('
		    <object width="%d" height="%d"
			    classid="clsid:8AD9C840-044E-11D1-B3E9-00805F499D93">
		    <!--[if !IE]>-->
		    <object width="%d" height="%d"
			    archive="%s/java/Metamorphose.jar" classid="java:Metamorphose">
		    <!--<![endif]-->
			<param name="code" value="Metamorphose"/>
			<param name="archive" value="%s/java/Metamorphose.jar"/>
			<param name="BackgroundColor" value="#666666"/>
			<param name="PanoramaRect" value="0,0,%d,%d"/>
			<param name="ScrollerRect" value="0,%d,%d,17"/>
			<param name="ScrollerThumb" value="%s/images/slider.png"/>
			<param name="PanoramaTile" value="%s"/>
			<param name="PanoramaSize" value="%d,%d"/>
		    <!--[if !IE]>-->
		    </object>
		    <!--<![endif]-->
		    </object>
		    ',
		    $viewWidth, $height + 17,
		    $viewWidth, $height + 17, $baseUrl, $baseUrl,
		    $viewWidth, $height,
		    $height, $viewWidth,
		    $baseUrl, $src, $width, $height);

	default:
	    return null;
	}
    }
}
?>
