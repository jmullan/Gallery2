<?php
/*
 * $RCSfile$
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2006 Bharat Mediratta
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA  02110-1301, USA.
 */
/**
 * @version $Revision$ $Date$
 * @package Rewrite
 * @subpackage PHPUnit
 * @author Douglas Cau <douglas@cau.se>
 */

/**
 * Path Info URL Generator tests
 *
 * @package Rewrite
 * @subpackage PHPUnit
 */
GalleryCoreApi::requireOnce(
    'modules/rewrite/classes/parsers/pathinfo/PathInfoUrlGenerator.class');
GalleryCoreApi::requireOnce('modules/rewrite/test/phpunit/RewriteUrlGeneratorTestCase.class');
class PathInfoUrlGeneratorTest extends RewriteUrlGeneratorTestCase {

    function PathInfoUrlGeneratorTest($methodName) {
	$this->GalleryTestCase($methodName);
    }

    function setUp() {
	global $gallery;
	parent::setUp();

	$parser = array(
	    'static' => array('/static' => 'Qg2_view=php.Static'),
	    'dynamic.find' => array('/\/p\/([a-z]{2})\/([^\?]+)/',
				    '/\/p\/([0-9]+).html/'),
	    'dynamic.replace' => array('Qg2_view=php.Dynamic&g2_language=$1&g2_path=$2',
				       'Qg2_view=php.Dynamic2&g2_itemId=$1'));

	/* Set up our environment */
	$ret = GalleryCoreApi::setPluginParameter('module', 'rewrite', 'pathinfo.parser',
	    serialize($parser));
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$_SERVER['HTTP_HOST'] = 'example.com';
	$_SERVER['REQUEST_URI'] = '/gallery2/main.php?foo=1&bar=2';
	$_SERVER['SERVER_PORT'] = 80;

	$ret = $this->_urlGeneratorInit('PathInfoUrlGenerator');
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

    }

    function testGetBaseUrl() {
	/* Standard G2 init */
	$_SERVER['REQUEST_URI'] = '/gallery2/phpunit_test.php?foo=bar&bar=foo';
	$urlGenerator = new PathInfoUrlGenerator();
	$ret = $urlGenerator->init('phpunit_test.php?foo=bar&bar=foo');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->assert(!$urlGenerator->_error);
	$this->assertEquals('http://example.com/gallery2/phpunit_test.php/',
			    $urlGenerator->_getBaseUrl(), 'baseUrl');
	$this->assertEquals('http://example.com/gallery2/phpunit_test.php/',
			    $urlGenerator->_getBaseUrl(true), 'baseUrl forceDirect');
	$this->assertEquals('?foo=bar&bar=foo', $urlGenerator->_getBaseParamString(), 'baseParam');
	$this->assertEquals('?foo=bar&bar=foo', $urlGenerator->_getBaseParamString(true),
			    'baseParam forceDirect');
    }

    function testGetBaseUrlEmbedded() {
	$_SERVER['REQUEST_URI'] = '/cms/index.php/?foo=bar&bar=foo';
	/* Embedded init with pathinfo and querystring in the base file */
	$urlGenerator = new PathInfoUrlGenerator();
	$ret = $urlGenerator->init('/cms/index.php/?foo=bar&bar=foo', '/gallery2/main.php');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->assert(!$urlGenerator->_error);
	$this->assertEquals('http://example.com/cms/index.php/', $urlGenerator->_getBaseUrl(),
			    'baseUrl');
	$this->assertEquals('http://example.com/gallery2/main.php/'
			    , $urlGenerator->_getBaseUrl(true), 'baseUrl forceDirect');
	$this->assertEquals('?foo=bar&bar=foo', $urlGenerator->_getBaseParamString(), 'baseParam');
	$this->assertEquals('', $urlGenerator->_getBaseParamString(true), 'baseParam forceDirect');
    }

    function testParsePathInfo() {
	/* test = array(path info, array of expected request variables */
	$basePath = array('', '/cms', '/cms/other');
	$tests = array();

	/* Test static path */
	$tests[] = array('/static',
			 array('view' => 'php.Static'));
	/* Test dynamic path */
	$tests[] = array('/p/en/bogus/file.jpg.html',
			 array('view' => 'php.Dynamic',
			       'language' => 'en',
			       'path' => 'bogus/file.jpg.html'));

	/* Test dynamic2 path */
	$tests[] = array('/p/911.html',
			 array('view' => 'php.Dynamic2',
			       'itemId' => '911'));

	foreach ($basePath as $path) {
	    foreach ($tests as $test) {
		list ($pathInfo, $expectedParams) = $test;
		$_SERVER['REQUEST_URI'] = $path . '/phpunit_test.php' . $pathInfo;
		$_SERVER['PATH_INFO'] = $path . '/phpunit_test.php' . $pathInfo;
		$urlGenerator = new PathInfoUrlGenerator();
		$ret = $urlGenerator->init($path . '/phpunit_test.php');
		if ($ret) {
		    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
		}

		foreach ($expectedParams as $param => $value) {
		    $actualValue = GalleryUtilities::getRequestVariables($param);
		    $this->assertEquals($value, $actualValue, $path . $pathInfo);
		    GalleryUtilities::removeRequestVariable($param);
		}
	    }
	}
    }

    function testGenerateUrlEmbeddedThenDirect() {
	$this->_expectedUrl[1] = sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
					  $this->_testItem->getId(),
					  $this->_testItem->getSerialNumber(),
					  urlencode($this->_testItem->getPathComponent()));
	parent::testGenerateUrlEmbeddedThenDirect();
    }
    
    function testGenerateUrl() {
	$this->_expectedUrl[0] =
	    '/gallery2/' . GALLERY_MAIN_PHP . '?g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] =
	    '/gallery2/' . GALLERY_MAIN_PHP . '?g2_controller=core.ShowItem&amp;' .
	    'g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/gallery2/' . GALLERY_MAIN_PHP;
	$this->_expectedUrl[6] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' . $this->_testAlbumPath;
	$this->_expectedUrl[7] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' . $this->_testItemPath .
	    '.html';
	$this->_expectedUrl[8] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_itemId=-5759';
	$this->_expectedUrl[9] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testAlbumPath, '/') . 'test.html';
	$this->_expectedUrl[11] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testItemPath, '/') . '/test.html';
	$this->_expectedUrl[12] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    rtrim($this->_testAlbumPath, '/') . '.test';
	$this->_expectedUrl[13] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    $this->_testItemPath . '.test';
	$this->_expectedUrl[14] = '/gallery2/' . GALLERY_MAIN_PHP . '/phpunit/';

	parent::testGenerateUrl();
    }

    function testGenerateUrlForceFullUrl() {
	$this->_expectedUrl[0] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP .
	    '?g2_view=rand164.NonShort&amp;g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP .
	    '?g2_controller=core.ShowItem&amp;g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = 'http://example.com/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP;
	$this->_expectedUrl[6] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/v' .
	    $this->_testAlbumPath;
	$this->_expectedUrl[7] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/v' .
	    $this->_testItemPath . '.html';
	$this->_expectedUrl[8] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP .
	    '?g2_itemId=-5759';
	$this->_expectedUrl[9] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP .
	    '?g2_itemId=' . $this->_derivative->getId();
	$this->_expectedUrl[10] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testAlbumPath, '/') .
	    'test.html';
	$this->_expectedUrl[11] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testItemPath, '/') .
	    '/test.html';
	$this->_expectedUrl[12] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    rtrim($this->_testAlbumPath, '/') .
	    '.test';
	$this->_expectedUrl[13] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    $this->_testItemPath . '.test';
	$this->_expectedUrl[14] = 'http://example.com/gallery2/' . GALLERY_MAIN_PHP . '/phpunit/';

	parent::testGenerateUrlForceFullUrl();
    }

    function testGenerateUrlForceSessionId() {
	global $gallery;
	$session =& $gallery->getSession();

	$sessionString = sprintf('g2_%s=%s', $session->getKey(), $session->getId());

	$this->_expectedUrl[0] =
	    '/gallery2/' . GALLERY_MAIN_PHP . '?g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar&amp;' . $sessionString;
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s?%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()), $sessionString);
	$this->_expectedUrl[2] = 'http://href_website.com/foo?' . $sessionString;
	$this->_expectedUrl[3] =
	    '/gallery2/' . GALLERY_MAIN_PHP . '?g2_controller=core.ShowItem&amp;' .
	    'g2_itemId=' . $this->_testItem->getId() . '&amp;' . $sessionString;
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg?' . $sessionString;
	$this->_expectedUrl[5] = '/gallery2/' . GALLERY_MAIN_PHP . '?' . $sessionString;
	$this->_expectedUrl[6] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' . $this->_testAlbumPath .
	    '?' . $sessionString;
	$this->_expectedUrl[7] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' . $this->_testItemPath .
	    '.html?' . $sessionString;
	$this->_expectedUrl[8] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_itemId=-5759&amp;' .
	    $sessionString;
	$this->_expectedUrl[9] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_itemId=' .
	    $this->_derivative->getId() . '&amp;' . $sessionString;
	$this->_expectedUrl[10] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testAlbumPath, '/') . 'test.html?' . $sessionString;
	$this->_expectedUrl[11] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testItemPath, '/') . '/test.html?' . $sessionString;
	$this->_expectedUrl[12] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    rtrim($this->_testAlbumPath, '/') . '.test?' . $sessionString;
	$this->_expectedUrl[13] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' . $this->_testItemPath .
	    '.test?' . $sessionString;
	$this->_expectedUrl[14] = '/gallery2/' . GALLERY_MAIN_PHP . '/phpunit/?' . $sessionString;

	parent::testGenerateUrlForceSessionId();
    }

    function testGenerateUrlNoHtmlEntities() {
	$this->_expectedUrl[0] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_view=rand164.NonShort&' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_controller=core.ShowItem&' .
	    'g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/gallery2/' . GALLERY_MAIN_PHP;
	$this->_expectedUrl[6] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' . $this->_testAlbumPath;
	$this->_expectedUrl[7] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' .
	    $this->_testItemPath . '.html';
	$this->_expectedUrl[8] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_itemId=-5759';
	$this->_expectedUrl[9] = '/gallery2/' . GALLERY_MAIN_PHP . '?g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testAlbumPath, '/') . 'test.html';
	$this->_expectedUrl[11] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testItemPath, '/') . '/test.html';
	$this->_expectedUrl[12] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    rtrim($this->_testAlbumPath, '/') . '.test';
	$this->_expectedUrl[13] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    $this->_testItemPath . '.test';
	$this->_expectedUrl[14] = '/gallery2/' . GALLERY_MAIN_PHP . '/phpunit/';

	parent::testGenerateUrlNoHtmlEntities();
    }
    
    function testGenerateUrlEmbeddedCookieless() {
	$sessionString = 'cmssid=12345'; 

	$this->_expectedUrl[0] = '/cms/index.php?mod=gallery2&amp;g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar&amp;' . $sessionString;
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s?%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()), $sessionString);
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = '/cms/index.php?mod=gallery2&amp;g2_controller=core.' .
	    'ShowItem&amp;g2_itemId=' . $this->_testItem->getId() . '&amp;' . $sessionString;
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/cms/index.php?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[6] = '/cms/index.php/v' . $this->_testAlbumPath .
	    '?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[7] = '/cms/index.php/v' . $this->_testItemPath .
	    '.html?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[8] = '/cms/index.php?mod=gallery2&amp;g2_itemId=-5759&amp;' .
	    $sessionString;
	$this->_expectedUrl[9] = '/cms/index.php?mod=gallery2&amp;g2_itemId=' .
	    $this->_derivative->getId() . '&amp;' . $sessionString;
	$this->_expectedUrl[10] = '/cms/index.php/' . ltrim($this->_testAlbumPath, '/') .
	    'test.html?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[11] = '/cms/index.php/' . ltrim($this->_testItemPath, '/') .
	    '/test.html?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[12] = '/cms/index.php/t' . rtrim($this->_testAlbumPath, '/') .
	    '.test?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[13] = '/cms/index.php/t' . $this->_testItemPath .
	    '.test?mod=gallery2&amp;' . $sessionString;
	$this->_expectedUrl[14] = '/cms/index.php/phpunit/?mod=gallery2&amp;' . $sessionString;

	parent::testGenerateUrlEmbeddedCookieless();
    }
    
    function testGenerateUrlEmbedded() {
	$this->_expectedUrl[0] = '/cms/index.php?mod=gallery2&amp;g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = '/cms/index.php?mod=gallery2&amp;' .
	    'g2_controller=core.ShowItem&amp;g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/cms/index.php?mod=gallery2';
	$this->_expectedUrl[6] = '/cms/index.php/v' . $this->_testAlbumPath . '?mod=gallery2';
	$this->_expectedUrl[7] = '/cms/index.php/v' . $this->_testItemPath . '.html?mod=gallery2';
	$this->_expectedUrl[8] = '/cms/index.php?mod=gallery2&amp;g2_itemId=-5759';
	$this->_expectedUrl[9] = '/cms/index.php?mod=gallery2&amp;g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = '/cms/index.php/' . ltrim($this->_testAlbumPath, '/') .
	    'test.html?mod=gallery2';
	$this->_expectedUrl[11] = '/cms/index.php/' . ltrim($this->_testItemPath, '/') .
	    '/test.html?mod=gallery2';
	$this->_expectedUrl[12] = '/cms/index.php/t' . rtrim($this->_testAlbumPath, '/') .
	    '.test?mod=gallery2';
	$this->_expectedUrl[13] = '/cms/index.php/t' . $this->_testItemPath . '.test?mod=gallery2';
	$this->_expectedUrl[14] = '/cms/index.php/phpunit/?mod=gallery2';

	parent::testGenerateUrlEmbedded();
    }

    function testGenerateUrlMultisite() {
	$this->_expectedUrl[0] = '/gallery2/main.php?g2_view=rand164.NonShort&amp;g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = '/gallery2/main.php?g2_controller=core.ShowItem&amp;' .
	    'g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = 'codebase/rep/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/gallery2/main.php';
	$this->_expectedUrl[6] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' . $this->_testAlbumPath;
	$this->_expectedUrl[7] = '/gallery2/' . GALLERY_MAIN_PHP . '/v' .
	    $this->_testItemPath . '.html';
	$this->_expectedUrl[8] = '/gallery2/main.php?g2_itemId=-5759';
	$this->_expectedUrl[9] = '/gallery2/main.php?g2_itemId=' . $this->_derivative->getId();
	$this->_expectedUrl[10] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testAlbumPath, '/') . 'test.html';
	$this->_expectedUrl[11] = '/gallery2/' . GALLERY_MAIN_PHP . '/' .
	    ltrim($this->_testItemPath, '/') . '/test.html';
	$this->_expectedUrl[12] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    rtrim($this->_testAlbumPath, '/') . '.test';
	$this->_expectedUrl[13] = '/gallery2/' . GALLERY_MAIN_PHP . '/t' .
	    $this->_testItemPath . '.test';
	$this->_expectedUrl[14] = '/gallery2/' . GALLERY_MAIN_PHP . '/phpunit/';

	parent::testGenerateUrlMultisite();
    }

    function testGenerateUrlEmbeddedMultisite() {
	$this->_expectedUrl[0] = '/cms/index.php?mod=gallery2&amp;g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] =
	    '/cms/index.php?mod=gallery2&amp;g2_controller=core.ShowItem&amp;' .
	    'g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = 'codebase/rep/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/cms/index.php?mod=gallery2';
	$this->_expectedUrl[6] = '/cms/index.php/v' . $this->_testAlbumPath . '?mod=gallery2';
	$this->_expectedUrl[7] = '/cms/index.php/v' . $this->_testItemPath . '.html?mod=gallery2';
	$this->_expectedUrl[8] = '/cms/index.php?mod=gallery2&amp;g2_itemId=-5759';
	$this->_expectedUrl[9] = '/cms/index.php?mod=gallery2&amp;g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = '/cms/index.php/' . ltrim($this->_testAlbumPath, '/') .
	    'test.html?mod=gallery2';
	$this->_expectedUrl[11] = '/cms/index.php/' . ltrim($this->_testItemPath, '/') .
	    '/test.html?mod=gallery2';
	$this->_expectedUrl[12] = '/cms/index.php/t' . rtrim($this->_testAlbumPath, '/') .
	    '.test?mod=gallery2';
	$this->_expectedUrl[13] = '/cms/index.php/t' . $this->_testItemPath . '.test?mod=gallery2';
	$this->_expectedUrl[14] = '/cms/index.php/phpunit/?mod=gallery2';

	parent::testGenerateUrlEmbeddedMultisite();
    }
    
    function testGenerateUrlEmbeddedCookiePathNotSet() {
	global $gallery;
	$session =& $gallery->getSession();

	$this->_expectedUrl[0] = '/cms/index.php?mod=gallery2&amp;g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s?g2_%s=%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()),
		    $session->getKey(), $session->getId());
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = '/cms/index.php?mod=gallery2&amp;' .
	    'g2_controller=core.ShowItem&amp;g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/cms/index.php?mod=gallery2';
	$this->_expectedUrl[6] = '/cms/index.php/v' . $this->_testAlbumPath . '?mod=gallery2';
	$this->_expectedUrl[7] = '/cms/index.php/v' . $this->_testItemPath . '.html?mod=gallery2';
	$this->_expectedUrl[8] = '/cms/index.php?mod=gallery2&amp;g2_itemId=-5759';
	$this->_expectedUrl[9] = '/cms/index.php?mod=gallery2&amp;g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = '/cms/index.php/' . ltrim($this->_testAlbumPath, '/') .
	    'test.html?mod=gallery2';
	$this->_expectedUrl[11] = '/cms/index.php/' . ltrim($this->_testItemPath, '/') .
	    '/test.html?mod=gallery2';
	$this->_expectedUrl[12] = '/cms/index.php/t' . rtrim($this->_testAlbumPath, '/') .
	    '.test?mod=gallery2';
	$this->_expectedUrl[13] = '/cms/index.php/t' . $this->_testItemPath . '.test?mod=gallery2';
	$this->_expectedUrl[14] = '/cms/index.php/phpunit/?mod=gallery2';

	parent::testGenerateUrlEmbeddedCookiePathNotSet();
    }

    function testGenerateUrlEmbeddedForceFullUrl() {
	$this->_expectedUrl[0] = 'https://cms.com/cms/index.php?mod=gallery2&amp;' .
	    'g2_view=rand164.NonShort&amp;g2_foo=bar';
	$this->_expectedUrl[1] =
	    sprintf('http://photos.com:81/gallery2/' . GALLERY_MAIN_PHP . '/d/%d-%d/%s',
		    $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
		    urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = 'https://cms.com/cms/index.php?mod=gallery2&amp;' .
	    'g2_controller=core.ShowItem&amp;g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = 'http://photos.com:81/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = 'https://cms.com/cms/index.php?mod=gallery2';
	$this->_expectedUrl[6] = 'https://cms.com/cms/index.php/v' . $this->_testAlbumPath .
	    '?mod=gallery2';
	$this->_expectedUrl[7] = 'https://cms.com/cms/index.php/v' . $this->_testItemPath .
	    '.html?mod=gallery2';
	$this->_expectedUrl[8] = 'https://cms.com/cms/index.php?mod=gallery2&amp;g2_itemId=-5759';
	$this->_expectedUrl[9] = 'https://cms.com/cms/index.php?mod=gallery2&amp;g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = 'https://cms.com/cms/index.php/' .
	    ltrim($this->_testAlbumPath, '/') . 'test.html?mod=gallery2';
	$this->_expectedUrl[11] = 'https://cms.com/cms/index.php/' .
	    ltrim($this->_testItemPath, '/') . '/test.html?mod=gallery2';
	$this->_expectedUrl[12] = 'https://cms.com/cms/index.php/t' .
	    rtrim($this->_testAlbumPath, '/') . '.test?mod=gallery2';
	$this->_expectedUrl[13] = 'https://cms.com/cms/index.php/t' . $this->_testItemPath .
	    '.test?mod=gallery2';
	$this->_expectedUrl[14] = 'https://cms.com/cms/index.php/phpunit/?mod=gallery2';

	parent::testGenerateUrlEmbeddedForceFullUrl();
    }

    function testGenerateUrlOverrideBaseUri() {
	$this->_expectedUrl[0] =
	    '/gallery2/index.php?page=photos&amp;g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] = sprintf('/gallery2/index.php/d/%d-%d/%s?page=photos',
				  $this->_testItem->getId(), $this->_testItem->getSerialNumber(),
				  urlencode($this->_testItem->getPathComponent()));
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = '/gallery2/index.php?page=photos&amp;' .
	    'g2_controller=core.ShowItem&amp;g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = '/gallery2/themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = '/gallery2/index.php?page=photos';
	$this->_expectedUrl[6] = '/gallery2/index.php/v' . $this->_testAlbumPath . '?page=photos';
	$this->_expectedUrl[7] = '/gallery2/index.php/v' . $this->_testItemPath .
	    '.html?page=photos';
	$this->_expectedUrl[8] = '/gallery2/index.php?page=photos&amp;g2_itemId=-5759';
	$this->_expectedUrl[9] = '/gallery2/index.php?page=photos&amp;g2_itemId=' .
	    $this->_derivative->getId();
	$this->_expectedUrl[10] = '/gallery2/index.php/' . ltrim($this->_testAlbumPath, '/') .
	    'test.html?page=photos';
	$this->_expectedUrl[11] = '/gallery2/index.php/' . ltrim($this->_testItemPath, '/') .
	    '/test.html?page=photos';
	$this->_expectedUrl[12] = '/gallery2/index.php/t' . rtrim($this->_testAlbumPath, '/') .
	    '.test?page=photos';
	$this->_expectedUrl[13] = '/gallery2/index.php/t' . $this->_testItemPath .
	    '.test?page=photos';
	$this->_expectedUrl[14] = '/gallery2/index.php/phpunit/?page=photos';

	parent::testGenerateUrlOverrideBaseUri();
    }

    function testGenerateUrlRewriteErrorFallback() {
	$this->_expectedUrl[0] = GALLERY_MAIN_PHP . '?g2_view=rand164.NonShort&amp;' .
	    'g2_foo=bar';
	$this->_expectedUrl[1] = sprintf(GALLERY_MAIN_PHP . '?g2_view=core.DownloadItem' .
				  '&amp;g2_itemId=%s&amp;g2_serialNumber=%s',
				  $this->_testItem->getId(), $this->_testItem->getSerialNumber());
	$this->_expectedUrl[2] = 'http://href_website.com/foo';
	$this->_expectedUrl[3] = GALLERY_MAIN_PHP . '?g2_controller=core.ShowItem&amp;' .
	    'g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[4] = 'themes/foo/images/bar.jpg';
	$this->_expectedUrl[5] = GALLERY_MAIN_PHP;
	$this->_expectedUrl[6] = GALLERY_MAIN_PHP . '?g2_itemId=' . $this->_testAlbum->getId();
	$this->_expectedUrl[7] = GALLERY_MAIN_PHP . '?g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[8] = GALLERY_MAIN_PHP . '?g2_itemId=-5759';
	$this->_expectedUrl[9] = GALLERY_MAIN_PHP . '?g2_itemId=' . $this->_derivative->getId();
	$this->_expectedUrl[10] = GALLERY_MAIN_PHP . '?g2_view=php.Unit&amp;g2_subView' .
	    '=test.suffixPath&amp;g2_itemId=' . $this->_testAlbum->getId();
	$this->_expectedUrl[11] = GALLERY_MAIN_PHP . '?g2_view=php.Unit&amp;g2_subView' .
	    '=test.suffixPath&amp;g2_itemId=' . $this->_testItem->getId();
	$this->_expectedUrl[12] = GALLERY_MAIN_PHP . '?g2_view=php.Unit&amp;g2_subView' .
	    '=test.suffixExt&amp;g2_itemId=' . $this->_testAlbum->getId();
	$this->_expectedUrl[13] = GALLERY_MAIN_PHP . '?g2_view=php.Unit&amp;g2_subView' .
	    '=test.suffixExt&amp;g2_itemId=' . $this->_testItem->getId();

	$this->_expectedUrl[14] = GALLERY_MAIN_PHP . '?g2_view=php.Unit';

	parent::testGenerateUrlRewriteErrorFallback();
    }
}
?>
