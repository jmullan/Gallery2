<?php
/*
 * $RCSfile
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2003 Bharat Mediratta
 * 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

/**
 * Representation of the one-to-many relationship between an item and its
 * properties
 *
 * @g2 <class-name>GalleryItemPropertiesMap</class-name>
 * @g2 <schema>
 * @g2   <schema-major>1</schema-major>
 * @g2   <schema-minor>0</schema-minor>
 * @g2 </schema>
 *
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @author Bharat Mediratta <bharat@menalto.com>
 */

class GalleryItemPropertiesMap_core {

    /**
     * @g2 <map>
     * @g2   <member>
     * @g2     <member-name>itemId</member-name>
     * @g2     <member-type>INTEGER</member-type>
     * @g2     <member-size>MEDIUM</member-size>
     * @g2   </member>
     * @g2   <member>
     * @g2     <member-name>key</member-name>
     * @g2     <member-type>STRING</member-type>
     * @g2     <member-size>MEDIUM</member-size>
     * @g2   </member>
     * @g2   <member>
     * @g2     <member-name>value</member-name>
     * @g2     <member-type>TEXT</member-type>
     * @g2   </member>
     * @g2   <key>
     * @g2     <member-name>itemId</member-name>
     * @g2     <member-name>key</member-name>
     * @g2   </key>
     * @g2 </map>
     */
    
    /**
     * Add a key/value mapping for the given item id
     *
     * @param int the id of the GalleryItem
     * @param string the key 
     * @param string the value
     * @return object GalleryStatus a status code
     */
    function addProperty($itemId, $key, $value) {
	global $gallery;
	
	if (empty($itemId) || empty($key) || empty($value)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	/*
	 * Add a new entry in our groups table to represent this
	 * relationship.
	 */
	$ret = GalleryItemPropertiesMap::addMapEntry(
            array('itemId' => $itemId, 'key' => $key, 'value' => $value));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	return GalleryStatus::success();
    }

    /**
     * Remove the specific item/key pair
     *
     * @param int the id of the GalleryItem
     * @return object GalleryStatus a status code
     */
    function removeProperty($itemId, $key) {
	global $gallery;
	if (empty($itemId) || empty($key)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	/*
	 * Remove this relationship from our groups table.
	 */
	$ret = GalleryItemPropertiesMap::removeMapEntry(
	    array('itemId' => $itemId, 'key' => $key));
	
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	return GalleryStatus::success();
    }

    /**
     * Change the specific item/key pair
     *
     * @param int the id of the GalleryItem
     * @param string the name of the property
     * @param string the value of the proprety
     * @return object GalleryStatus a status code
     */
    function updateProperty($itemId, $key, $value) {
	global $gallery;
	if (empty($itemId) || empty($key) || empty($value)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	/*
	 * Remove this item/key from the map, and add the new one.
	 */
	$ret = GalleryItemPropertiesMap::removeMapEntry(
	    array('itemId' => $itemId, 'key' => $key));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$ret = GalleryItemPropertiesMap::addMapEntry(
	    array('itemId' => $itemId, 'key' => $key, 'value' => $value));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	return GalleryStatus::success();
    }

    /**
     * Remove all properties for the given item id
     *
     * @param int the id of the GalleryItem
     * @return object GalleryStatus a status code
     */
    function removeProperties($itemId) {
	global $gallery;
	if (empty($itemId)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	/*
	 * Remove this relationship from our groups table.
	 */
	$ret = GalleryItemPropertiesMap::removeMapEntry(
	    array('itemId' => $itemId));
	
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	return GalleryStatus::success();
    }

    /**
     * Return a list of all the property keys for this item
     *
     * @return array object GalleryStatus a status code
     *               array group ids
     */
    function fetchPropertyKeys($itemId) {
	global $gallery;

	if (empty($itemId)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	$query = '
        SELECT
          [GalleryItemPropertyMap::key]
        FROM
          [GalleryItemPropertyMap]
        WHERE
          [GalleryItemPropertyMap::itemId] = ?
        ';

	list ($ret, $searchResults) = $gallery->search($query, array($itemId));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$data = array();
	while ($result = $searchResults->nextResult()) {
	    $data[] = $result[0];
	}
	return array($ret, $data);
    }

    /**
     * Get the value for a specific property
     *
     * @param int the id of the GalleryItem
     * @param string the desired key
     * @return array object GalleryStatus a status code
     *               string value
     */
    function fetchProperty($itemId, $key) {
	global $gallery;

	if (empty($itemId) || empty($key)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	$query = '
        SELECT
          [GalleryItemPropertyMap::value]
        FROM
          [GalleryItemPropertyMap]
        WHERE
          [GalleryItemPropertyMap::itemId] = ?
          AND
          [GalleryItemPropertyMap::key] = ?
        ';

	list ($ret, $searchResults) =
	    $gallery->search($query, array($itemId, $key));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	if ($searchResults->resultCount() == 0) {
	    return null;
	}

	$result = $searchResults->nextResult();
	return array($ret, $result[0]);
    }

    /**
     * Get all the key/values for a specific GalleryItem
     *
     * @param int the id of the GalleryItem
     * @return array object GalleryStatus a status code
     *               array key => value pairs
     */
    function fetchAllProperties($itemId, $key) {
	global $gallery;

	if (empty($itemId)) {
	    return GalleryStatus::error(ERROR_BAD_PARAMETER,
					__FILE__, __LINE__);
	}

	$query = '
        SELECT
          [GalleryItemPropertyMap::key],
          [GalleryItemPropertyMap::value]
        FROM
          [GalleryItemPropertyMap]
        WHERE
          [GalleryItemPropertyMap::itemId] = ?
        ';

	list ($ret, $searchResults) = $gallery->search($query, array($itemId));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	if ($searchResults->resultCount() == 0) {
	    return null;
	}

	$data = array();
	while ($result = $searchResults->nextResult()) {
	    $data[$result[0]] = $result[1];
	}
	return array($ret, $data);
    }

}

include(dirname(__FILE__) . '/interfaces/GalleryItemPropertiesMap.inc');
?>