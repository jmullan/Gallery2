<?php
/*
 * $RCSfile$
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2004 Bharat Mediratta
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * Internationalization and Localization utilities
 *
 * @package GalleryCore
 * @subpackage Classes
 */
class GalleryTranslator {
    /*
     * ****************************************
     *                 Members
     * ****************************************
     */

    /**
     * Keep track of the gettext domains we've already bound
     *
     * @var array $_boundDomains
     * @access private
     */
    var $_boundDomains;

    /**
     * The active character set.
     *
     * @var string $_activeCharset
     * @access private
     */
    var $_activeCharset;

    /**
     * Does the active language read right-to-left?
     *
     * @var array $_isRightToLeft
     * @access private
     */
    var $_isRightToLeft;

    /*
     * ****************************************
     *                 Methods
     * ****************************************
     */

    function GalleryTranslator() {
	$this->_boundDomains = array();
    }

    /**
     * Can we translate?
     *
     * @return boolean
     * @static
     */
    function canTranslate() {
	return function_exists('dgettext');
    }

    /**
     * Can we make plural translations?
     *
     * @return boolean
     * @static
     */
    function canTranslatePlural() {
	return function_exists('dngettext');
    }

    /**
     * Does the active language read right-to-left?
     *
     * @return boolean
     */
    function isRightToLeft() {
	return $this->_isRightToLeft;
    }

    /**
     * Return our language data
     *
     * @return array array['language code']['country code'] = array('description', 'charset code')
     *         array array('country' => 'default language code',
     *                     'country' => 'default language code',
     *                     ...)
     * @static
     */
    function getLanguageData() {
	static $supportedLanguages = array();
	static $defaultCountry = array();

	if (empty($supportedLanguages)) {
	    /* XXX: Move this information into a configuration file */
	    // German
	    $supportedLanguages['de']['DE']['description'] = 'Deutsch';
	    $supportedLanguages['de']['DE']['charset'] = 'UTF-8';
	    $defaultCountry['de'] = 'DE';

	    // Greek
	    $supportedLanguages['el']['GR']['description'] = 'Greek';
	    $supportedLanguages['el']['GR']['charset'] = 'UTF-8';
	    $defaultCountry['el'] = 'GR';

	    // English
	    $supportedLanguages['en']['US']['description'] = 'English (US)';
	    $supportedLanguages['en']['US']['charset'] = 'UTF-8';
	    $supportedLanguages['en']['GB']['description'] = 'English (UK)';
	    $supportedLanguages['en']['GB']['charset'] = 'UTF-8';
	    $defaultCountry['en'] = 'US';

	    // Spanish
	    $supportedLanguages['es']['AR']['description'] = 'Espa&#241;ol (AR)';
	    $supportedLanguages['es']['AR']['charset'] = 'UTF-8';
	    $defaultCountry['es'] = 'AR';

	    // Spanish
	    $supportedLanguages['es']['MX']['description'] = 'Espa&#241;ol (MX)';
	    $supportedLanguages['es']['MX']['charset'] = 'UTF-8';
	    $defaultCountry['es'] = 'MX';

	    // Finnish
	    $supportedLanguages['fi']['FI']['description'] = 'Suomi';
	    $supportedLanguages['fi']['FI']['charset'] = 'UTF-8';
	    $defaultCountry['fi'] = 'FI';

	    // Polish
	    $supportedLanguages['pl']['PL']['description'] = 'Polski';
	    $supportedLanguages['pl']['PL']['charset'] = 'UTF-8';
	    $defaultCountry['pl'] = 'PL';

	    // Portuguese
	    $supportedLanguages['pt']['BR']['description'] = 'Portugu&#234;s Brasileiro';
	    $supportedLanguages['pt']['BR']['charset'] = 'UTF-8';
	    $supportedLanguages['pt']['PT']['description'] = 'Portugu&#234;s (PT)';
	    $supportedLanguages['pt']['PT']['charset'] = 'UTF-8';
	    $defaultCountry['pt'] = 'BR';

	    // Chinese
	    $supportedLanguages['zh']['CN']['description'] = '&#31616;&#20307;&#20013;&#25991;';
	    $supportedLanguages['zh']['CN']['charset'] = 'UTF-8';
	    $supportedLanguages['zh']['TW']['description'] = '&#32321;&#39636;&#20013;&#25991;';
	    $supportedLanguages['zh']['TW']['charset'] = 'UTF-8';
	    $defaultCountry['zh'] = 'TW';

	    // Dutch
	    $supportedLanguages['nl']['NL']['description'] = 'Nederlands';
	    $supportedLanguages['nl']['NL']['charset'] = 'UTF-8';
	    $defaultCountry['nl'] = 'NL';

	    // Norwegian
	    $supportedLanguages['no']['NO']['description'] = 'Norsk bokm&#229;l';
	    $supportedLanguages['no']['NO']['charset'] = 'UTF-8';
	    $defaultCountry['no'] = 'NO';

	    // Japanese
	    $supportedLanguages['ja']['JP']['description'] = '&#x65e5;&#x672c;&#x8a9e;';
	    $supportedLanguages['ja']['JP']['charset'] = 'UTF-8';
	    $defaultCountry['ja'] = 'JP';

	    // Irish
	    $supportedLanguages['ga']['IE']['description'] = 'Irish';
	    $supportedLanguages['ga']['IE']['charset'] = 'UTF-8';
	    $defaultCountry['ga'] = 'IE';

	    // French
	    $supportedLanguages['fr']['FR']['description'] = 'Fran&#231;ais';
	    $supportedLanguages['fr']['FR']['charset'] = 'UTF-8';
	    $defaultCountry['fr'] = 'FR';

	    // Swedish
	    $supportedLanguages['sv']['SE']['description'] = 'Svenska';
	    $supportedLanguages['sv']['SE']['charset'] = 'UTF-8';
	    $defaultCountry['sv'] = 'SE';

	    // Hebrew
	    $supportedLanguages['he']['IL']['description'] = '&#1506;&#1489;&#1512;&#1497;&#1514;';
	    $supportedLanguages['he']['IL']['charset'] = 'UTF-8';
	    $supportedLanguages['he']['IL']['right-to-left'] = true;
	    $defaultCountry['he'] = 'IL';

	    // Italian
	    $supportedLanguages['it']['IT']['description'] = 'Italiano';
	    $supportedLanguages['it']['IT']['charset'] = 'UTF-8';
	    $defaultCountry['it'] = 'IT';

	    // Danish
	    $supportedLanguages['da']['DK']['description'] = 'Dansk';
	    $supportedLanguages['da']['DK']['charset'] = 'UTF-8';
	    $defaultCountry['da'] = 'DK';

	    // Turkish
	    $supportedLanguages['tr']['TR']['description'] = 'T&#252;rk&#231;e';
	    $supportedLanguages['tr']['TR']['charset'] = 'UTF-8';
	    $defaultCountry['tr'] = 'TR';

	    // Serbian
	    $supportedLanguages['sr']['YU']['description'] = 'Srpski';
	    $supportedLanguages['sr']['YU']['charset'] = 'UTF-8';
	    $defaultCountry['sr'] = 'YU';

	    // Slovenian
	    $supportedLanguages['sl']['SI']['description'] = 'Sloven&#353;&#269;ina';
	    $supportedLanguages['sl']['SI']['charset'] = 'UTF-8';
	    $defaultCountry['sl'] = 'SI';
	}

	return array($supportedLanguages, $defaultCountry);
    }

    /**
     * Return the list of languages that we support.
     * Return our language data
     *
     * @return array['language code']['country code'] =
     *              array('description', 'charset code')
     */
    function getSupportedLanguages() {
	/* Get our language data */
	list ($supportedLanguages, $defaultCountry) = GalleryTranslator::getLanguageData();
	return $supportedLanguages;
    }

    /**
     * Initialize the translator with the specified language code hint
     *
     * @param string the language code hint (eg. 'en_US' or 'zh_CN')
     * @return object GalleryStatus a status code
     */
    function init($languageCode=null) {
	if (empty($languageCode)) {
	    $languageCode = GalleryTranslator::getLanguageCodeFromRequest();
	}

	list ($languageCode, $data) = GalleryTranslator::getSupportedLanguageCode($languageCode);

	/* If we're using gettext, try to bind to a language */
	if (function_exists('dgettext')) {
	    /*
	     * Set the appropriate charset in our HTTP header
	     */
	    $this->_activeCharset = $data['charset'];
	    if (!headers_sent()) {
		header('Content-Type: text/html; charset=' . $this->_activeCharset);
	    }
	    $this->_isRightToLeft = isset($data['right-to-left']);
	    /*
	     * Some systems only require LANG, others (like Mandrake) seem to require
	     * LANGUAGE also.
	     */
	    putenv("LANG=${languageCode}");
	    putenv("LANGUAGE=${languageCode}");

	    // XXX: we'd like to say:
	    //    setlocale(LC_ALL, "${language}_${country}", "${language}");
	    // but the setlocale() call doesn't accept fallbacks until PHP 4.3+

	    setlocale(LC_ALL, $languageCode);
	}

	return GalleryStatus::success();
    }

    /**
     * Find a supported locale from given string.
     *
     * @param string the language code hint
     * @param boolean (optional) if false, return array(null,null) for no match instead of en_US
     * @return array (string a language code in <language>_<COUNTRY> format,
     *                array data about this language code (description,charset))
     * @static
     */
    function getSupportedLanguageCode($languageCode, $fallback=true) {
	static $supportedLanguages;
	static $defaultCountry;
	if (!isset($supportedLanguages)) {
	    list ($supportedLanguages, $defaultCountry) = GalleryTranslator::getLanguageData();
	}

	list ($language, $country) = preg_split('/[-_]/', "${languageCode}_");
	$country = strtoupper($country);
	if ((empty($country) || !isset($supportedLanguages[$language][$country]))
		&& isset($defaultCountry[$language])) {
	    // Use default country if none specified or particular country not supported
	    $country = $defaultCountry[$language];
	}
	if (isset($supportedLanguages[$language][$country])) {
	    return array("${language}_${country}", $supportedLanguages[$language][$country]);
	}
	return $fallback ? array('en_US', $supportedLanguages['en']['US']) : array(null, null);
    }

    /**
     * Examine the incoming request and try to figure out what languages the
     * browser will accept.  Take the first one that we can support.
     *
     * @return a language code in the <language>_<COUNTRY> format, eg: en_US
     * @static
     */
    function getLanguageCodeFromRequest() {
	/* Take the first thing the browser accepts that we can use */
	if (!empty($_SERVER['HTTP_ACCEPT_LANGUAGE'])) {
	    foreach (explode(',', $_SERVER['HTTP_ACCEPT_LANGUAGE'])
		     as $code) {

		list ($languageCode) = GalleryTranslator::getSupportedLanguageCode($code, false);
		if (isset($languageCode)) {
		    return $languageCode;
		}
	    }
	}

	/* Fall back to English (US) */
	return 'en_US';
    }

    /**
     * Localize the given content
     *
     * Expected inputs are of the form:
     *
     * Example 1:
     *  $data['text'] = 'Some text to localize with %d arguments'
     *  $data['arg1'] = 5;
     *
     *  localized:  'Some text to localize with 5 arguments'
     *
     * Example 2:
     *  $data['one'] =   'You have %d orange'
     *  $data['many'] =  'You have %d oranges'
     *  $data['count'] = 3 (or 1);
     *
     * localized:  'You have 3 oranges'  (or 'You have 1 orange')
     *
     * @param string the domain (eg, a module id)
     * @param string a directory
     * @param mixed a single string, or an array of parameters
     * @return array object GalleryStatus a status code
     *               string the localized value
     */
    function translateDomain($domain, $data) {
	global $gallery;

	/* Validate our parameters */
	if (!(isset($data['text']) ||
	      (isset($data['one']) && isset($data['many']) && isset($data['count'])))) {
	    return array(GalleryStatus::error(ERROR_BAD_PARAMETER, __FILE__, __LINE__),
			 null);
	}

	$platform = $gallery->getPlatform();
	if (function_exists('dgettext')) {
	    if (isset($domain) && !isset($this->_boundDomains[$domain])) {
		list ($componentType, $componentName) = split('_', $domain);
		$basePath = sprintf('%s/%s/%s/locale',
				    $platform->realpath(dirname(__FILE__) . '/../../..'),
				    $componentType,
				    $componentName);
		if ($gallery->getDebug()) {
		    $gallery->debug("Binding text domain: $domain -> $basePath");
		}
		bindtextdomain($domain, $basePath);
		textdomain($domain);
		if (function_exists('bind_textdomain_codeset')) {
		    bind_textdomain_codeset($domain, $this->_activeCharset);
		}
		$this->_boundDomains[$domain] = $basePath;
	    }

	    /*
	     * We have to have dngettext (which is only available > PHP 4.2.0,
	     * according to the PHP manual) in order to do pluralization
	     * translations.  If we don't have have dngettext() we try to
	     * gracefully degrade to using dgettext().
	     */
	    if (isset($data['one'])) {
		if (function_exists('dngettext')) {
		    $localized = dngettext($domain, $data['one'], $data['many'], $data['count']);
		} else {
		    /*
		     * It would make more sense to fall back to $data['many']
		     * here, since the odds are better that it will be more
		     * applicable.  However, due to the way that we do the
		     * pluralization, the keys will be organized by the
		     * $data['one'] entry so there won't be a $data['many'] key
		     * for dgettext() to use.  :-(
		     */
		    $localized = dgettext($domain, $data['one']);
		}
	    } else {
		$localized = dgettext($domain, $data['text']);
	    }
	    if (! function_exists('bind_textdomain_codeset') && function_exists('nl_langinfo') ) {
		/*
		 * If there is no bind_textdomain_codeset (PHP 4.1.x), the
		 * string will be returned from gettext in the default
		 * encoding for that language. Here we convert that encoding
		 * to the active charset manually.
		 * Note: 'nl_langinfo' is not available under Win32, so this
		 * "hack" only works on Unix-systems.
		 */
		$codeSet = nl_langinfo(CODESET);
		/* Suppress warnings, which can happen in $codeSet is not supported */
		if (function_exists('mb_convert_encoding')) {
		    $localized = @mb_convert_encoding($localized, $this->_activeCharset, $codeSet);
		} else if (function_exists('iconv')) {
		    $localized = @iconv($codeSet, $this->_activeCharset, $localized);
		} else if (function_exists('recode_string')) {
		    $localized = @recode_string($codeSet . '..' . $this->_activeCharset, $localized);
		}
	    }
	} else {
	    /*
	     * The server doesn't have gettext, so fake it using the source of
	     * the message (which is almost definitely in US English)
	     */
	    if (isset($data['text'])) {
		$localized = $data['text'];
	    } else if ($data['count'] == 1) {
		$localized = $data['one'];
	    } else {
		$localized = $data['many'];
	    }
	}

	$i = 1;
	$args = array();
	while (isset($data['arg' . $i])) {
	    $args[] = $data['arg' . $i];
	    $i++;

	    /* Catch runaways */
	    if ($i > 100) {
		return array(GalleryStatus::error(ERROR_UNKNOWN, __FILE__, __LINE__), null);
	    }
	}

	/*
	 * If we have arguments, then feed the localized string and the
	 * arguments into sprintf.
	 */
	if (sizeof($args) > 0) {
	    array_unshift($args, $localized);
	    $localized = call_user_func_array('sprintf', $args);
	}

	/*
	 * This is a useful debug routine.  Uncomment it to have every
	 * string prefixed with the domain it was localized in.
	 */
	//$localized = "[$domain: $localized]";

	return array(GalleryStatus::success(), $localized);
    }
}
?>
