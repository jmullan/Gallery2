<?php
/*
 * $RCSfile$
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2005 Bharat Mediratta
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * This class is a glue layer between the templating system and our various
 * callbacks that generate URLs, localized text, dates, themed widgets, etc.
 *
 * @package GalleryCore
 * @subpackage Classes
 */
class GalleryTemplateAdapter {

    /**
     * The number of times our block callbacks have been executed
     * @var array _callCount
     */
    var $_callCount;

    /**
     * Custom smarty blocks registered by other modules
     *
     * @var array _blocks
     * @access private
     */
    var $_blocks;

    /**
     * Constructor
     */
    function GalleryTemplateAdapter() {
	$this->_callCount = $this->_blocks = array();
    }

    /*************************************************************
     * Special purpose template callback methods.
     *************************************************************/

    /**
     * @see GalleryUrlGenerator::generateUrl()
     *
     * Return a valid Gallery URL, standalone or embedded.
     *
     * @param array data in key/value pairs
     * @return string a URL
     */
    function url($params, &$smarty) {
	global $gallery;

	if (isset($params['href'])) {
	    $hrefParams = array('href' => $params['href']);
	} else if (isset($params['params'])) {
	    /* All the user to pass in bulk params */
	    $hrefParams = $params['params'];
	} else {
	    $hrefParams = array();

	    /* Search for args and add them to the params */
	    $i = 1;
	    while (isset($params['arg' . $i])) {
		list ($key, $value) = explode('=', $params['arg' . $i]);
		$hrefParams[$key] = $value;
		$i++;
	    }
	}

	if (isset($params['forceSessionId'])) {
	    $forceSessionId = $params['forceSessionId'];
	} else {
	    $forceSessionId = null;
	}

	$urlGenerator =& $gallery->getUrlGenerator();
	$url = $urlGenerator->generateUrl($hrefParams, $forceSessionId);

	if (!empty($params['forJavascript'])) {
	    $url = str_replace('&amp;', '&', $url);
	}

	return $url;
    }

    /**
     * Return any hidden form variables that we want to embed in this form based on the
     * current session and request context.  We use this to pass the special "return" variable
     * forward, for example.
     *
     * @param array data in key/value pairs
     * @return a series of XHTML 1.0 compliant <input> elements
     */
    function hiddenFormVars($params, &$smarty) {
	global $gallery;
	$urlGenerator =& $gallery->getUrlGenerator();
	$vars = array();

	/* The 'return' url */
	if (GalleryUtilities::hasRequestVariable('return')) {
	    $vars['return'] = GalleryUtilities::getRequestVariables('return');
	}

	/* Remember the current url for getting back to where we came from */
	if (empty($vars['return'])) {
	    $currentView = $gallery->getCurrentView();
	    list ($ret, $view) = GalleryView::loadView($currentView);
	    if ($ret->isError()) {
		$viewDescription = '';
	    } else {
		list ($ret, $viewDescription) = $view->getViewDescription();
		if ($ret->isError()) {
		    $viewDescription = '';
		}
	    }
	    $vars['returnName'] = $viewDescription;
	    $vars['return'] = $urlGenerator->getNavigationReturnUrl();
	}

	/* Our navigation id */
	$navigationId = $urlGenerator->getNavigationId();
	if (!empty($navigationId)) {
	    $vars['navId'] = $navigationId;
	    unset($vars['return']);
	}

	/* Remember the original URL where this form was first shown */
	$vars['formUrl'] = GalleryUtilities::getRequestVariables('formUrl');
	if (empty($vars['formUrl'])) {
	    /* First time we load this form */
	    $vars['formUrl'] = $urlGenerator->getNavigationReturnUrl();
	}

	$out = '';
	foreach ($vars as $key => $value) {
	    $out .= sprintf('<input type="hidden" name="%s" value="%s"/>' . "\n",
			   GalleryUtilities::prefixFormVariable($key),
			   $value);
	}
	return $out;
    }

    /**
     * Return a valid Gallery date.
     *
     * @todo This needs to be refactored.
     *
     * @param array data in key/value pairs
     * @return string a URL
     */
    function date($params, &$smarty) {
	return GalleryCoreApi::convertToUtf8(
	    strftime(!empty($params['format']) ? $params['format'] : '%x',
		     !empty($params['timestamp']) ? $params['timestamp'] : time()));
    }

    /**
     * @see GalleryTranslator::translate()
     */
    function text($params, &$smarty) {
	global $gallery;

	if (isset($params['l10Domain'])) {
	    $domain = $params['l10Domain'];
	} else {
	    $domain = $smarty->_tpl_vars['l10Domain'];
	}
	$translator =& $gallery->getTranslator();
	list ($ret, $text) = $translator->translateDomain($domain, $params);
	if ($ret->isError()) {
	    return $ret->getAsHtml();
	    return "[Translation error]";
	}

	if (!empty($params['forJavascript'])) {
	    $text = str_replace("'", "\\'", $text);
	}

	return $text;
    }

    /**
     * Return a transformed element name, useful when we're trying to use
     * Javascript to access a form element.
     *
     * @param array key => value attributes
     * @return HTML content
     */
    function formVar($params) {
	return GalleryUtilities::prefixFormVariable($params['var']);
    }

    /**
     * Delegate to the appropriate item class to render an image.
     *
     * @param array containing item, image, maxSize, fallback, and any img attributes
     * @param object Smarty the smarty instance
     * @return string HTML content
     */
    function image($params, &$smarty) {
	/* Ask the entity to render itself in HTML */
	list ($ret, $item) = GalleryCoreApi::loadEntitiesById($params['item']['id']);
	if ($ret->isError()) {
	    /* TODO: is there a more graceful way to handle this? */
	    return '[Render error: missing item]';
	}

	list ($ret, $entity) = GalleryCoreApi::loadEntitiesById($params['image']['id']);
	if ($ret->isError()) {
	    /* TODO: is there a more graceful way to handle this? */
	    return '[Render error: missing entity]';
	}

	unset($params['item']);
	unset($params['image']);
	if (isset($params['fallback'])) {
	    $fallback = $params['fallback'];
	} else {
	    $fallback = $params['fallback'] = null;
	}

	if ($entity->getId() == $item->getId()) {
	    $html = $item->render('HTML', $params);
	} else {
	    $html = $entity->render('HTML', $item, $params);
	}

	return !empty($html) ? $html : $fallback;
    }

    /**
     * Render head content
     *
     * @param array
     * @param object Smarty the smarty instance
     * @return string HTML content
     */
    function head($params, &$smarty) {
	global $gallery;
	$urlGenerator =& $gallery->getUrlGenerator();
	$templateVars =& $smarty->get_template_vars();
	$head = $templateVars['head'];
	$output = array("\n");

	/* Title */
	if (isset($head['title'])) {
	    $output[] = '<title>' . $head['title'] . "</title>\n";
	}

	/* Style */
	foreach ($head['style'] as $path) {
	    $output[] = sprintf('<link rel="stylesheet" type="text/css" href="%s"/>' . "\n",
				$urlGenerator->generateUrl(array('href' => $path)));
	}

	/* Javascript */
	if (isset($head['javascript'])) {
	    foreach ($head['javascript'] as $path) {
		$output[] = sprintf('<script type="text/javascript" src="%s"></script>' . "\n",
			$urlGenerator->generateUrl(array('href' => $path)));
	    }
	}

	/* Tpl to include */
	foreach ($head['tpl'] as $path => $l10Domain) {
	    $smarty->_smarty_include(
		array('smarty_include_tpl_file' => "gallery:$path",
		      'smarty_include_vars' => array('l10Domain' => $l10Domain)));
	}

	return implode('', $output);
    }

    /**
     * Include our AutoCompletion template.
     *
     * @param array
     * @param string content
     * @param object Smarty the smarty instance
     * @return string HTML content
     */
    function autoComplete($params, $content, &$smarty) {
	if (!isset($content)) {
	    if (!isset($this->_callCount['autoComplete'])) {
		$this->_callCount['autoComplete'] = 0;
	    }
	    return;
	}
	$this->_callCount['autoComplete']++;
	$url = trim($content);
	$smarty->_smarty_include(
	    array('smarty_include_tpl_file' => 'gallery:modules/core/templates/AutoComplete.tpl',
		  'smarty_include_vars' =>
			array('element' => $params['element'],
			      'url' => $url,
			      'callCount' => $this->_callCount['autoComplete'])));
    }

    /**
     * Include form inputs for dimensions.
     *
     * @param array params
     * @param object Smarty the smarty instance
     * @return string HTML content
     */
    function dimensions($params, &$smarty) {
	if (!isset($this->_callCount['dimensions'])) {
	    $this->_callCount['dimensions'] = 0;
	}
	$smarty->_smarty_include(
	    array('smarty_include_tpl_file' => 'gallery:modules/core/templates/Dimensions.tpl',
		  'smarty_include_vars' => array(
				 'formVar' => $params['formVar'],
				 'formVarId' => strtr($params['formVar'], '[]', '__'),
				 'width' => isset($params['width']) ? $params['width'] : null,
				 'height' => isset($params['height']) ? $params['height'] : null,
				 'callCount' => ++$this->_callCount['dimensions'])));
    }

    /**
     * Register a new block callback.
     * Use {g->block type="blocktype"}..{/g->block} in a template to call the block.
     *
     * @param string block type
     * @param callback function to call
     */
    function register_block($blockType, $callback) {
	$this->_blocks[$blockType] = $callback;
    }

    /**
     * A smarty block callback to support block functions registered by modules.
     *
     * @param array data in key/value pairs
     * @param string content inside the block
     * @param object Smarty
     */
    function block($params, $content, &$smarty) {
	if (!isset($content)) {
	    return;
	}
	if (empty($params['type']) || empty($this->_blocks[$params['type']])) {
	    return $content;
	}
	$callback = $this->_blocks[$params['type']];
	if (is_array($callback)) {
	    list ($object, $function) = $callback;
	    if (!is_object($object)) {
		$object = new $object();
	    }
	    return $object->$function($params, $content, $smarty);
	} else {
	    return $function($params, $content, $smarty);
	}
    }

    /**
     * This takes an array and looks for view, subview, and controller to make
     * a linkid (being used as a css classname)
     *
     * @param array the items to make a css class out of
     * @return string the id of the css class
     */
    function linkId($params) {
	$linkId = 'gbLink';
	if (!empty($params['urlParams']['controller'])) {
	    $linkId .= '-' . $params['urlParams']['controller'];
	}
	if (!empty($params['view'])) {
	    $linkId .= '-' . $params['view'];
	} elseif (!empty($params['urlParams']['view'])) {
	    $linkId .= '-' . $params['urlParams']['view'];
	}
	if (!empty($params['urlParams']['subView'])) {
	    $linkId .= '-' . $params['urlParams']['subView'];
	}
	return GalleryTemplateAdapter::_safeCssName($linkId);
    }
    
    /**
     * This removes unsafe characters from a string so they can be used as a class
     * name or id in html and be addressed via css
     *
     * Purpose:  Removes characters from a string so that it can be used for an
     * html class name or id and be addressed via css
     *
     * @private
     * @param string the input string
     * @return string
     */
    function _safeCssName($string) {
	$string = ereg_replace("[^-A-Za-z0-9_]", "_", $string);
	$string = ereg_replace('__+', '_', $string);
	$string = ereg_replace('[-_][-_]+', '-', $string);
	return $string;
    }
}
?>
