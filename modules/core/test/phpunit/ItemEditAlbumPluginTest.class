<?php
/*
 * $RCSfile$
 *
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2006 Bharat Mediratta
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA  02110-1301, USA.
 */
/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @subpackage PHPUnit
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * ItemEditAlbum controller tests
 * @package GalleryCore
 * @subpackage PHPUnit
 */
class ItemEditAlbumPluginTest extends ItemEditPluginTestCase {

    function ItemEditAlbumPluginTest($methodName) {
	$this->ItemEditPluginTestCase($methodName, 'core', 'ItemEditAlbum');
    }

    function setUp() {
	parent::setUp();

	/* Register a dummy entity */
	$path = 'modules/core/test/phpunit/ItemEditAlbumPluginTest.class';
	$ret = GalleryCoreApi::registerFactoryImplementation(
	    'GalleryEntity', 'ItemEditAlbumPluginTestDataItem', 'ItemEditAlbumPluginTestDataItem',
	    $path, 'coreTest', null);
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/* Register a dummy toolkit */
	$ret = GalleryCoreApi::registerFactoryImplementation(
	    'GalleryToolkit', 'ItemEditAlbumPluginTestToolkit', 'ItemEditAlbumPluginTestToolkit',
	    $path, 'coreTest', null);
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	$this->_markToolkitForCleanup('ItemEditAlbumPluginTestToolkit');
	$this->_markFactoryModuleForCleanup('coreTest');

	/* Register operations that we can perform on our mock data items */
	$ret = GalleryCoreApi::registerToolkitOperation('ItemEditAlbumPluginTestToolkit',
		array('test/file'), 'scale',
		array(array('type' => 'int', 'description' => 'test'),
		      array('type' => 'int', 'description' => 'test')),
		'test-description');
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$ret = GalleryCoreApi::registerToolkitOperation('ItemEditAlbumPluginTestToolkit',
		array('test/file'), 'thumbnail',
		array(array('type' => 'int', 'description' => 'test'),
		      array('type' => 'int', 'description' => 'test')),
		'test-description');
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$ret = GalleryCoreApi::registerToolkitOperation('ItemEditAlbumPluginTestToolkit',
		array('test/file'), 'crop',
		array(array('type' => 'float', 'description' => 'test'),
		      array('type' => 'float', 'description' => 'test'),
		      array('type' => 'float', 'description' => 'test'),
		      array('type' => 'float', 'description' => 'test')), 'test-description');
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $this->_album) = $this->_createRandomAlbum($this->_getRootId());
	if ($ret) {
	    print $ret->getAsHtml();
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->_markForCleanup($this->_album);
    }

    function testUndo() {
	/* Use valid inputs */
	GalleryUtilities::putRequestVariable('form[action][undo]', 1);

	/* Perform the request and verify that we succeeded */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array(), null), $results);
    }

    function testSave() {

	/* Use valid inputs */
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[theme]', 'bar');
	GalleryUtilities::putRequestVariable('form[orderBy]', 'baz');
	GalleryUtilities::putRequestVariable('form[orderDirection]', 'bletch');
	GalleryUtilities::putRequestVariable('form[presort]', 'foa');
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 234);
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 234);
	GalleryUtilities::putRequestVariable('form[resizes][1][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][1][width]', 345);
	GalleryUtilities::putRequestVariable('form[resizes][1][height]', 543);
	GalleryUtilities::putRequestVariable('form[resizes][2][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][2][width]', 456);
	GalleryUtilities::putRequestVariable('form[resizes][2][height]', 456);
	GalleryUtilities::putRequestVariable('form[serialNumber]',
					     $this->_album->getSerialNumber());

	/* Perform the request and verify that we succeeded */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array(),
				  $this->_translate('Settings saved successfully.')),
			    $results);

	list ($ret, $this->_album) = $this->_album->refresh();
	if ($ret) {
	    $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/* Verify basic settings */
	$this->assertEquals('bar', $this->_album->getTheme());
	$this->assertEquals('foa|baz', $this->_album->getOrderBy());
	$this->assertEquals('bletch', $this->_album->getOrderDirection());

	/* Verify derivative preferences */
	list ($ret, $preferences) =
	    GalleryCoreApi::fetchDerivativePreferencesForItem($this->_album->getId());
	if ($ret) {
	    $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	$this->assert(array(array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|234,234'),
			    array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|345,543'),
			    array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|456,456')),
		      $preferences);
    }

    function testInvalidSave() {

	/* Use valid inputs */
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 'foo');
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 'foo');
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 100);
	GalleryUtilities::putRequestVariable('form[resizes][1][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][1][width]', 100);
	GalleryUtilities::putRequestVariable('form[resizes][1][height]', 'foo');
	GalleryUtilities::putRequestVariable('form[resizes][2][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][2][width]', -10);
	GalleryUtilities::putRequestVariable('form[resizes][2][height]', 100);

	/* Perform the request and verify that we failed */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array('form[error][thumbnail][size][invalid]',
					'form[error][resizes][0][size][invalid]',
					'form[error][resizes][1][size][invalid]',
					'form[error][resizes][2][size][invalid]'),
				  null),
			    $results);
    }

    function testInvalidSave2() {

	/* Use valid inputs */
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][1][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][2][active]', 1);

	/* Perform the request and verify that we failed */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array('form[error][resizes][0][size][missing]',
					'form[error][resizes][1][size][missing]',
					'form[error][resizes][2][size][missing]'),
				  null),
			    $results);
    }

    function testInvalidSerialNumber() {
	/* valid inputs */
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[theme]', 'bar');
	GalleryUtilities::putRequestVariable('form[orderBy]', 'baz');
	GalleryUtilities::putRequestVariable('form[orderDirection]', 'bletch');
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 234);
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 234);
	GalleryUtilities::putRequestVariable('form[resizes][1][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][1][width]', 345);
	GalleryUtilities::putRequestVariable('form[resizes][1][height]', 543);
	GalleryUtilities::putRequestVariable('form[resizes][2][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][2][width]', 456);
	GalleryUtilities::putRequestVariable('form[resizes][2][height]', 456);
	/* invalid serial number */
	GalleryUtilities::putRequestVariable('form[serialNumber]', -1);

	$results = $this->handleRequest($this->_album, $this->_preferred, ERROR_OBSOLETE_DATA);
    }

    function testSaveAndRecreate() {
	global $gallery;

	/* Create some children */
	for ($i = 0; $i < 2; $i++) {
	    list ($ret, $child[$i]) = $this->_createRandomDataItem(
		$this->_album->getId(), 'test/file', array(),
		__FILE__, 'ItemEditAlbumPluginTestDataItem');
	    if ($ret) {
		return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	    }
	}

	/* and subalbum with grandchildren */
	list ($ret, $this->_childAlbum) = $this->_createRandomAlbum($this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	list ($ret, $child[2]) = $this->_createRandomDataItem(
	    $this->_childAlbum->getId(), 'test/file', array(),
	    __FILE__, 'ItemEditAlbumPluginTestDataItem');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $ignore) = $this->_createDerivative($child[0], $child[0]->getId(),
							DERIVATIVE_TYPE_IMAGE_THUMBNAIL,
							'thumbnail|100',
							'test/file');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $ignore) = $this->_createDerivative($child[0], $child[0]->getId(),
							DERIVATIVE_TYPE_IMAGE_RESIZE,
							'scale|100,100',
							'test/file');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $ignore) = $this->_createDerivative($child[1], $child[1]->getId(),
							DERIVATIVE_TYPE_IMAGE_THUMBNAIL,
							'crop|0,0,50,50;thumbnail|100',
							'test/file');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $ignore) = $this->_createDerivative($child[1], $child[1]->getId(),
							DERIVATIVE_TYPE_IMAGE_PREFERRED,
							'rotate|90',
							'test/file');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $ignore) = $this->_createDerivative($child[2], $child[2]->getId(),
							DERIVATIVE_TYPE_IMAGE_THUMBNAIL,
							'crop|0,0,80,80;thumbnail|150',
							'test/file');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $ignore) = $this->_createDerivative($child[2], $child[2]->getId(),
							DERIVATIVE_TYPE_IMAGE_PREFERRED,
							'rotate|180',
							'test/file');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/* Use valid inputs */
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[theme]', 'bar');
	GalleryUtilities::putRequestVariable('form[orderBy]', '');
	/* for empty orderBy, orderDirection can be omitted */
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 234);
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 234);
	GalleryUtilities::putRequestVariable('form[resizes][1][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][1][width]', 345);
	GalleryUtilities::putRequestVariable('form[resizes][1][height]', 543);
	GalleryUtilities::putRequestVariable('form[resizes][2][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][2][width]', 456);
	GalleryUtilities::putRequestVariable('form[resizes][2][height]', 456);
	GalleryUtilities::putRequestVariable('form[recreateThumbnails]', 1);
	GalleryUtilities::putRequestVariable('form[recreateResizes]', 1);
	GalleryUtilities::putRequestVariable('form[serialNumber]',
					     $this->_album->getSerialNumber());

	$mockAdapter = new MockTemplateAdapter();
	$gallery->_templateAdapter =& $mockAdapter;

	/* Perform the request and verify that we succeeded */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array(),
				  $this->_translate('Settings saved successfully.')),
			    $results);

	/* Assert that we have 2 callbacks in the queue (recreate thumbnails and resies) */
	$this->assertEquals(2, $mockAdapter->getCallbackCount());

	/* Run the tasks */
	$ret = $mockAdapter->runCallbacks();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $this->_album) = $this->_album->refresh();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/* Verify the thumbnail and resizes on our children */
	list ($ret, $thumbnails) =
	    GalleryCoreApi::fetchThumbnailsByItemIds(array($child[0]->getId(),
		$child[1]->getId(), $child[2]->getId()));
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->assertEquals('thumbnail|123',
	    $thumbnails[$child[0]->getId()]->getDerivativeOperations());
	$this->assertEquals('crop|0,0,50,50;thumbnail|123',
	    $thumbnails[$child[1]->getId()]->getDerivativeOperations());
	$this->assertEquals('crop|0,0,80,80;thumbnail|123',
	    $thumbnails[$child[2]->getId()]->getDerivativeOperations());

	list ($ret, $resizes) =
	    GalleryCoreApi::fetchResizesByItemIds(array($child[0]->getId(),
		$child[1]->getId(), $child[2]->getId()));
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	for ($i = 0; $i < 3; $i++) {
	    $childId = $child[$i]->getId();
	    if (!isset($resizes[$childId])) {
		$this->assert(false, "Missing resizes for child $i");
		continue;
	    }
	    if (count($resizes[$childId]) < 3) {
		$this->assert(false,
			      "Only " . count($resizes[$childId]) . " resizes for child $i");
		continue;
	    }
	    $this->assertEquals('scale|234,234',
		$resizes[$child[$i]->getId()][0]->getDerivativeOperations(), "$i 0");
	    $this->assertEquals('scale|345,543',
		$resizes[$child[$i]->getId()][1]->getDerivativeOperations(), "$i 1");
	    $this->assertEquals('scale|456,456',
		$resizes[$child[$i]->getId()][2]->getDerivativeOperations(), "$i 2");
	}
    }

    /**
     * Add a small (dimension wise) photo to an album and make sure that we don't create resizes
     * that are larger (dimension wise) than the original.
     */
    function testRecreateResizesForSmallPhoto() {
	global $gallery;

	list ($ret, $lockId) = GalleryCoreApi::acquireReadLock($this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/*
	 * Set the album preferences such that we have one resize that's smaller than the
	 * original, and one that's larger.  We know that the image we're using is 62x75
	 */
	$ret = GalleryCoreApi::removeDerivativePreferencesForItem($this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	list ($ret, $photo) = GalleryCoreApi::newItemByMimeType('image/gif');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$ret = $photo->create($this->_album->getId(),
			      dirname(__FILE__) . '/../data/test1.gif',
			      'image/gif',
			      'test image');
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$ret = GalleryCoreApi::addExistingItemToAlbum($photo, $this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$ret = $photo->save();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$ret = GalleryCoreApi::releaseLocks($lockId);
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/* Use valid inputs */
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[theme]', 'bar');
	GalleryUtilities::putRequestVariable('form[orderBy]', 'baz');
	GalleryUtilities::putRequestVariable('form[orderDirection]', 'bletch');
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 50);
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 50);
	GalleryUtilities::putRequestVariable('form[resizes][1][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][1][width]', 100);
	GalleryUtilities::putRequestVariable('form[resizes][1][height]', 100);
	GalleryUtilities::putRequestVariable('form[recreateResizes]', 1);
	GalleryUtilities::putRequestVariable('form[serialNumber]',
					     $this->_album->getSerialNumber());

	$mockAdapter = new MockTemplateAdapter();
	$gallery->_templateAdapter =& $mockAdapter;

	/* Perform the request and verify that we succeeded */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array(),
				  $this->_translate('Settings saved successfully.')),
			    $results);

	/* Assert that we have 1 callback in the queue */
	$this->assertEquals(1, $mockAdapter->getCallbackCount());

	/* Run the tasks */
	$ret = $mockAdapter->runCallbacks();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/* Now verify that we didn't upsample our resizes */
	list ($ret, $resizes) = GalleryCoreApi::fetchResizesByItemIds(array($photo->getId()));
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->assert(isset($resizes[$photo->getId()]), 'Missing resizes for new photo');
	if (isset($resizes[$photo->getId()])) {
	    $resizes = $resizes[$photo->getId()];
	    $this->assertEquals(1, sizeof($resizes), 'There should only be one resize');
	    $this->assertEquals(
		'scale|50,50', $resizes[0]->getDerivativeOperations(),
		'The resize operation should be resize|50,50');
	}
    }
    /**
     * Test applying options from 'Album' tab to sub-albums
     */
    function testChangeInDescendents() {
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[orderBy]', 'baz');
	GalleryUtilities::putRequestVariable('form[orderDirection]', 'bletch');
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 50);
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 50);
	GalleryUtilities::putRequestVariable('form[theme]', 'bar');
	GalleryUtilities::putRequestVariable('form[serialNumber]',
					     $this->_album->getSerialNumber());

	GalleryUtilities::putRequestVariable('form[changeInDescendents][theme]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][sort]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][thumbnail]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][resizes]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][orderBy]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][orderDirection]', 1);

	list ($ret, $this->_childAlbum) = $this->_createRandomAlbum($this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	/*
	 * Also check the grandchild album - to make sure that descendents don't
	 * just return children
	 */
	list ($ret, $this->_grandchildAlbum) = $this->_createRandomAlbum(
            $this->_childAlbum->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	/* Perform the request and verify that we succeeded */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array(),
				  $this->_translate('Settings saved successfully.')),
			    $results);
        /* On the album itself */
	list ($ret, $this->_album) = $this->_album->refresh();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->assertEquals('bar', $this->_album->getTheme(), 'Album');
	$this->assertEquals('baz', $this->_album->getOrderBy(), 'Album');
	$this->assertEquals('bletch', $this->_album->getOrderDirection(), 'Album');

	list ($ret, $preferences) = GalleryCoreApi::fetchDerivativePreferencesForItem(
	    $this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
        usort ($preferences, "ItemEditAlbumPluginTestCmp");
	$this->assertEquals(array(
			    array('order' => 0,
				  'derivativeType' => 1,
				  'derivativeOperations' => 'thumbnail|123'),
                            array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|50,50')),
		      $preferences);

	/* On the child */
	list ($ret, $this->_childAlbum) = $this->_childAlbum->refresh();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	$this->assertEquals('bar', $this->_childAlbum->getTheme(), 'Child');
	$this->assertEquals('baz', $this->_childAlbum->getOrderBy(), 'Child');
	$this->assertEquals('bletch', $this->_childAlbum->getOrderDirection(), 'Child');
	list ($ret, $preferences) = GalleryCoreApi::fetchDerivativePreferencesForItem(
	    $this->_childAlbum->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	usort ($preferences, "ItemEditAlbumPluginTestCmp");
	$this->assertEquals(array(
			    array('order' => 0,
				  'derivativeType' => 1,
				  'derivativeOperations' => 'thumbnail|123'),
                            array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|50,50')),
		      $preferences, 'child');

	/* On the grandchild */
	list ($ret, $this->_grandchildAlbum) = $this->_grandchildAlbum->refresh();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	$this->assertEquals('bar', $this->_grandchildAlbum->getTheme(), 'grandchild');
	$this->assertEquals('baz', $this->_grandchildAlbum->getOrderBy(), 'grandchild');
	$this->assertEquals('bletch', $this->_grandchildAlbum->getOrderDirection(), 'grandchild');
	list ($ret, $preferences) = GalleryCoreApi::fetchDerivativePreferencesForItem(
	    $this->_grandchildAlbum->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
	usort ($preferences, "ItemEditAlbumPluginTestCmp");
	$this->assertEquals(array(
			    array('order' => 0,
				  'derivativeType' => 1,
				  'derivativeOperations' => 'thumbnail|123'),
                            array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|50,50')),
		      $preferences, 'grandchild');

    }
    
    /**
     * Test applying options from 'Album' tab to sub-albums with no subalbums
     */
    function testChangeInDescendentsLeaf() {
	GalleryUtilities::putRequestVariable('form[action][save]', 1);
	GalleryUtilities::putRequestVariable('form[thumbnail][size]', 123);
	GalleryUtilities::putRequestVariable('form[orderBy]', 'baz');
	GalleryUtilities::putRequestVariable('form[orderDirection]', 'bletch');
	GalleryUtilities::putRequestVariable('form[resizes][0][active]', 1);
	GalleryUtilities::putRequestVariable('form[resizes][0][width]', 50);
	GalleryUtilities::putRequestVariable('form[resizes][0][height]', 50);
	GalleryUtilities::putRequestVariable('form[theme]', 'bar');
	GalleryUtilities::putRequestVariable('form[serialNumber]',
					     $this->_album->getSerialNumber());

	GalleryUtilities::putRequestVariable('form[changeInDescendents][theme]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][sort]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][thumbnail]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][resizes]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][orderBy]', 1);
	GalleryUtilities::putRequestVariable('form[changeInDescendents][orderDirection]', 1);
	/* Perform the request and verify that we succeeded */
	$results = $this->handleRequest($this->_album, $this->_preferred);
	$this->assertEquals(array(array(),
				  $this->_translate('Settings saved successfully.')),
			    $results);
        /* On the album itself */
	list ($ret, $this->_album) = $this->_album->refresh();
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}

	$this->assertEquals('bar', $this->_album->getTheme(), 'Album');
	$this->assertEquals('baz', $this->_album->getOrderBy(), 'Album');
	$this->assertEquals('bletch', $this->_album->getOrderDirection(), 'Album');

	list ($ret, $preferences) = GalleryCoreApi::fetchDerivativePreferencesForItem(
	    $this->_album->getId());
	if ($ret) {
	    return $this->failWithStatus($ret->wrap(__FILE__, __LINE__));
	}
        usort ($preferences, "ItemEditAlbumPluginTestCmp");
	$this->assertEquals(array(
			    array('order' => 0,
				  'derivativeType' => 1,
				  'derivativeOperations' => 'thumbnail|123'),
                            array('order' => 0,
				  'derivativeType' => 2,
				  'derivativeOperations' => 'scale|50,50')),
		      $preferences);
    }

}

function ItemEditAlbumPluginTestCmp($a, $b) {
    return $a['derivativeType'] - $b['derivativeType'];
}

GalleryCoreApi::requireOnce('modules/core/classes/GalleryDataItem.class');
GalleryCoreApi::requireOnce('modules/core/classes/GalleryToolkit.class');

/**
 * Mock data item
 * @package GalleryCore
 * @subpackage PHPUnit
 */
class ItemEditAlbumPluginTestDataItem extends GalleryDataItem {
    /**
     * @see GalleryEntity::getClassName()
     */
    function getClassName() {
	return 'ItemEditAlbumPluginTestDataItem';
    }
}

/**
 * Mock toolkit
 * @package GalleryCore
 * @subpackage PHPUnit
 */
class ItemEditAlbumPluginTestToolkit extends GalleryToolkit { }
?>
