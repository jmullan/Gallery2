<?php

/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @subpackage TestCase
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * @package GalleryCore
 * @subpackage TestCase
 */
class EmptyGalleryTestCase extends TestCase {

    function getDescription() {
	return "Clean out all the Gallery filesystem data.";
    }

    function testStart() {
	global $gallery;

	// Make sure that all the required paths exist.
	$platform = $gallery->getPlatform();

	// Scrub the contents of the gallery data directory
	$baseDir = $gallery->getConfig('data.gallery.base');
	$dir = $platform->opendir($baseDir);

	while (($filename = $platform->readdir($dir)) !== false) {
	    if (!strcmp($filename, '.') || !strcmp($filename, '..')) {
		continue;
	    }
	    $path = "$baseDir$filename";
	    
	    if ($platform->is_dir($path)) {
		$ret = $platform->recursiveRmdir($path);
	    } else {
		$ret = $platform->unlink($path);
	    }
	    
	    if ($ret == false) {
		return false;
	    }
	}
	closedir($dir);

	// Recreate the gallery data directory
	foreach (array('data.gallery.albums',
		       'data.gallery.cache',
		       'data.gallery.locks',
		       'data.gallery.sessions',
		       'data.gallery.tmp',
		       'data.smarty.base',
		       'data.smarty.templates_c') as $key) {
	    $dir = $gallery->getConfig($key);

	    if (empty($dir)) {
		return GalleryStatus::error(ERROR_BAD_PATH, __FILE__, __LINE__);
	    }

	    if (!$platform->file_exists($dir)) {
		$ret = $platform->mkdir($dir);
		if (!$ret) {
		    return GalleryStatus::error(ERROR_UNKNOWN, __FILE__, __LINE__);
		}
	    }
	}

	foreach (array('locks') as $key) {
	    $dir = $gallery->getConfig('data.gallery.base') . '/' . $key;

	    if (empty($dir)) {
		return GalleryStatus::error(ERROR_BAD_PATH, __FILE__, __LINE__);
	    }

	    for ($i = 0; $i <= 9; $i++) {
		if (!$platform->file_exists("$dir/$i")) {
		    $ret = $platform->mkdir("$dir/$i");
		    if (!$ret) {
			return GalleryStatus::error(ERROR_UNKNOWN, __FILE__, __LINE__);
		    }
		}

		for ($j = 0; $j <= 9; $j++) {
		    if (!$platform->file_exists("$dir/$i/$j")) {
			$ret = $platform->mkdir("$dir/$i/$j");
			if (!$ret) {
			    return GalleryStatus::error(ERROR_UNKNOWN, __FILE__, __LINE__);
			}
		    }
		}
	    }
	}

	return GalleryStatus::success();
    }
}
?>
