<?php

class EmptyGalleryTestCase extends TestCase {

    function getDescription() {
	return "Clean out all the Gallery filesystem data.";
    }

    function testStart() {
	global $gallery;

	list($ret, $platform) = $gallery->getPlatform();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$dirs = array();
	foreach (array('data.gallery.albums',
		       'data.gallery.cache',
		       'data.gallery.tmp',
		       'data.smarty.base')
		 as $param) {
	    list ($ret, $dir) =
		$gallery->getModuleParameter('core', $param);
	    if ($ret->isError()) {
		// Ignore
	    } else {
		if (!empty($dir)) {
		    $dirs[] = $dir;
		}
	    }
	}

	$setup = $gallery->getConfig('code.gallery.setup');
	list ($ret, $smarty) = $gallery->getSmarty($setup . 'smarty/templates_c');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	foreach ($dirs as $dir) {

	    if (empty($dir)) {
		return GalleryStatus::error(ERROR_BAD_PATH, __FILE__, __LINE__);
	    }

	    if ($platform->file_exists($dir)) {
		$ret = $platform->recursiveRmdir($dir);
		if (!$ret) {
		    return GalleryStatus::error(ERROR_BAD_PATH, __FILE__, __LINE__);
		}
	    }
	}

	return GalleryStatus::success();
    }
}
?>
