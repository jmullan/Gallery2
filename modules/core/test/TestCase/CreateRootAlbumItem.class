<?php

class CreateRootAlbumItemTestCase extends TestCase {

    function getDescription() {
	return "Create a new AlbumItem, save it, modify it, save it again";
    }

    function testStart() {
	global $gallery;

	/* Do we already have a root? */
	list ($ret, $rootAlbumId) =
	    $gallery->getModuleParameter('core', 'id.rootAlbum');
	if ($rootAlbumId) {
	    return GalleryStatus::error(ERROR_COLLISION, __FILE__, __LINE__);
	}
	
	print("Creating new root album item\n");
	list ($ret, $album) = $gallery->newEntity('GalleryAlbumItem');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	$ret = $album->createRoot("test", $gallery->getActiveUserId());
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	$album->setDescription("This is a longish description with " .
				     "+=!@#$%^&*()_-|\\\"'?/>.<,}]{[~` chars in it");

	print("SAVE\n");
	$ret = $album->save();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	print("ASSIGN PERMISSIONS\n");
	/* Give all users some stuff */
	list ($ret, $groupId) =
	    $gallery->getModuleParameter('core', 'id.allUserGroup');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	foreach (array('core.view', 'core.viewResizes') as $permission) {
	    $ret = GalleryPermissionMap::addGroupPermission($album->getId(),
							    $groupId,
							    $permission);
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
	}

	/* Grant admin users everything */
	list ($ret, $groupId) =
	    $gallery->getModuleParameter('core', 'id.adminGroup');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$ret = GalleryPermissionMap::addGroupPermission($album->getId(),
							$groupId,
							'core.all');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$ret = $gallery->setModuleParameter('core', 'id.rootAlbum',
					    $album->getId());
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	return GalleryStatus::success();
    }
}

?>
