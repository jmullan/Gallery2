<?php

class DeleteAllItemsTestCase extends TestCase {

    function getIterations() {
	return array(1);
    }

    function getDescription() {
	return "Delete all AlbumItems in the database, one by one (except the root)";
    }

    function testStart() {
	global $gallery;

	while (true) {
	    $gallery->setTimeLimit(60);

	    list ($ret, $rootAlbumId) = $gallery->getModuleParameter('core', 'id.rootAlbum');
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
	    
	    list ($ret, $results) =
		$gallery->search(array('select' => '[GalleryEntity::id]',
				       'where' => ('[GalleryEntity::entityType] = ? ' .
						   'AND [GalleryEntity::id] <> ?'),
				       'order-by' => '[GalleryEntity::id] DESC',
				       'limit' => array('offset' => 0, 'count' => 5)),
				 array('GalleryAlbumItem', $rootAlbumId));
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

	    if ($results->resultCount() == 0) {
		break;
	    }

	    while ($result = $results->nextResult()) {
		$id = $result[0];
		$ret = $gallery->deleteEntityById($id);
		if ($ret->isError()) {
		    return $ret->wrap(__FILE__, __LINE__);
		}
	    }
	}

	return GalleryStatus::success();
    }
}

?>

