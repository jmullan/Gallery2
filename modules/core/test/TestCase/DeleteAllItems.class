<?php

class DeleteAllItemsTestCase extends TestCase {

    var $_id = 1;

    function getDescription() {
	return "Delete all items in the database, one by one";
    }

    function testStart() {
	global $gallery;

	$ret = $gallery->lockWorld();
	if ($ret->isError()) {
	    return $ret;
	}
	    
	while (true) {
	    set_time_limit(60);
	    
	    list ($ret, $results) =
		    $gallery->search(array(),
				     array('GalleryNucleus::id'),
				     array(array(SEARCH_LIMIT, 1)));
	    if ($ret->isError()) {
		return $ret;
	    }

	    if (empty($results)) {
		break;
	    }
	    
	    $id = $results[0]['GalleryNucleus::id'];
	    print "<H2> Delete Item $id </H2>\n";
	    $ret = $gallery->deleteNucleusById($id);
	    if ($ret->isError()) {
		if (!($ret->getErrorCode() & ERROR_DELETED_OBJECT)) {
		    return $ret;
		}
	    }

	    /* Commit the cache */
	    $ret = $gallery->commitCache();
	    if ($ret->isError()) {
		return $ret;
	    }
	}

	$ret = $gallery->unlock();
	if ($ret->isError()) {
	    return $ret;
	}

	return GalleryStatus::success();
    }
}

?>
</pre>
