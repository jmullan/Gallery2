<?php
/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @subpackage TestCase
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * @package GalleryCore
 * @subpackage TestCase
 */
class DeleteAllItemsTestCase extends TestCase {

    function getIterations() {
	return array(1);
    }

    function getDescription() {
	return "Delete all AlbumItems in the database, one by one (except the root)";
    }

    function testStart() {
	global $gallery;

	while (true) {
	    $gallery->guaranteeTimeLimit(60);

	    list ($ret, $rootAlbumId) = GalleryCoreApi::getPluginParameter('module', 'core', 'id.rootAlbum');
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

	    $query = '
            SELECT
              [GalleryEntity::id]
            FROM
              [GalleryEntity]
            WHERE
              [GalleryEntity::entityType] = ?
              AND
              [GalleryEntity::id] <> ?
            ORDER BY
              [GalleryEntity::id] DESC
                ';
	    /*
	     * XXX: we shouldn't be making direct search calls from our
	     * test cases.
	     */
	    list ($ret, $results) =
		$gallery->search($query,
				 array('GalleryAlbumItem', $rootAlbumId),
				 array('limit' => array('offset' => 0, 'count' => 5)));
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

	    if ($results->resultCount() == 0) {
		break;
	    }

	    while ($result = $results->nextResult()) {
		$id = $result[0];
		$ret = GalleryCoreApi::deleteEntityById($id);
		if ($ret->isError()) {
		    return $ret->wrap(__FILE__, __LINE__);
		}
	    }
	}

	return GalleryStatus::success();
    }
}
?>
