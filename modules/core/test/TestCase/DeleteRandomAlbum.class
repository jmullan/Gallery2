<?php

/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @subpackage TestCase
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * @package GalleryCore
 * @subpackage TestCase
 */
class DeleteRandomAlbumTestCase extends TestCase {

    function getIterations() {
	return array(1, 2, 3, 5, 10, 20);
    }

    function getDescription() {
	return "Pick delete a random album that lives under the root";
    }

    function testStart($iterations) {
	global $gallery;

	$gallery->debug("Choosing an album");
	$lockIds = array();

	list ($ret, $rootId) =
	    $gallery->getModuleParameter('core', 'id.rootAlbum');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	$userId = $gallery->getActiveUserId();

	/* Load the root */
	list ($ret, $root) = $gallery->loadEntitiesById($rootId);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	/*
	 * Read lock it so it doesn't move around.  If we were deleting
	 * something that lives under multiple levels we'd need to read lock
	 * all the parents.
	 */
	list ($ret, $lockIds[]) = $gallery->acquireReadLock($rootId);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	/* Get the children */ 
	list ($ret, $children) = $root->fetchChildren($userId);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$i = 0;
	$chosen = 0;
	foreach ($children as $child) {
	    if (!strcasecmp($child->getEntityType(), "GalleryAlbumItem")) {
		if (rand(0, $i++) == 0) {
		    $chosen = $child->getId();
		}
	    }
	}

	if ($chosen == 0) {
	    $gallery->debug("No album chosen!");
	} else {
	    list ($ret, $lockIds[]) = $gallery->acquireWriteLock($chosen);
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

	    list ($ret, $album) = $gallery->loadEntitiesById($chosen);
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

	    $title = $album->getTitle();
	    $gallery->debug("Deleting: $chosen ($title)");
	    
	    $ret = $album->delete();
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
	}

	$ret = $gallery->releaseLocks($lockIds);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	return GalleryStatus::success();
    }
}

?>
