<?php

class InitializeGalleryTestCase extends TestCase {

    function getDescription() {
	return "Create a new Gallery directory structure.";
    }

    function testStart() {
	global $gallery;

	/*
	 * Make sure that all the required paths exist.
	 */
	list($ret, $platform) = $gallery->getPlatform();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	foreach (array('data.gallery.albums',
		       'data.gallery.cache',
		       'data.gallery.tmp',
		       'data.smarty.base',
		       'data.smarty.templates_c') as $key) {
	    $dir = $gallery->getConfig($key);

	    if (empty($dir)) {
		return GalleryStatus::error(ERROR_BAD_PATH, __FILE__, __LINE__);
	    }

	    if (!$platform->file_exists($dir)) {
		$ret = $platform->mkdir($dir);
		if (!$ret) {
		    return GalleryStatus::error(ERROR_UNKNOWN, __FILE__, __LINE__);
		}
	    }
	}

	/*
	 * Load and initialize the core module.  Normally this is done at the
	 * very beginning of all of our operations, so doing this now is going
	 * to cause all kinds of weirdness.  This is a test case, so it's ok to
	 * break a few rules to maintain continuity.  Make sure that any
	 * relevant data (like config values) survive this transition.
	 */
	$oldConfig = $gallery->_config;
	
	require_once(dirname(__FILE__) . '/../../module.inc');
	$coreModule = new CoreModule();
	$ret = $coreModule->init();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	/* We changed the global gallery -- update our pointer */
	$gallery =& $GLOBALS['gallery'];

	foreach ($oldConfig as $key => $value) {
	    $gallery->setConfig($key, $value);
	}

	/* Let the core module install itself, if necessary */
	list ($ret, $coreModule) = $gallery->loadModule('core');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$ret = $coreModule->install();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	return GalleryStatus::success();
    }
}
?>
