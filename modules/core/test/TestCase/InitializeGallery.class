<?php

/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @subpackage TestCase
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * @package GalleryCore
 * @subpackage TestCase
 */
class InitializeGalleryTestCase extends TestCase {

    function getDescription() {
	return "Create a new Gallery directory structure.";
    }

    function testStart() {
	global $gallery;

	/*
	 * Load and initialize the core module.  Normally this is done at the
	 * very beginning of all of our operations, so doing this now is going
	 * to cause all kinds of weirdness.  This is a test case, so it's ok to
	 * break a few rules to maintain continuity.  Make sure that any
	 * relevant data (like config values) survive this transition.
	 */
	$oldGallery = $gallery;

	/* Get rid of the data cache */
	GalleryDataCache::reset(true);

	/* Get rid of event listeners, else they can screw up our reinstall process */
	GalleryCoreApi::relativeRequireOnce('modules/core/classes/helpers/GalleryEventHelper_simple.class');
	$listeners =& GalleryEventHelper_simple::_getEventListeners();
	foreach (array_keys($listeners) as $eventName) {
	    unset($listeners[$eventName]);
	}

	$ret = GalleryInitFirstPass(array('noDatabase' => 1));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	/* We changed the global gallery -- update our pointer */
	$gallery =& $GLOBALS['gallery'];

	/*
	 * We'll need a translator to load up the core module for the
	 * GalleryPlugin::setGroup() method to work.
	 */
	$translator =& $gallery->getTranslator();
	if (empty($translator)) {
	    $ret = $gallery->initTranslator(true /* dontUseDatabase */ );
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
	}

	/* Reinstall the core */
	list ($ret, $core) = GalleryCoreApi::loadPlugin('module', 'core', true);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	$ret = $core->installOrUpgrade(true);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	list ($ret, $moduleList) = GalleryCoreApi::fetchPluginStatus('module');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	foreach (array_keys($moduleList) as $moduleId) {
	    list ($ret, $module) = GalleryCoreApi::loadPlugin('module', $moduleId);
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

	    /* We install everything for development environments */
	    $ret = $module->installOrUpgrade();
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
		
	    list ($ret, $success) = $module->autoConfigure();
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
		
	    if ($success) {
		list ($ret, $redirect) = $module->activate();
		if ($ret->isError()) {
		    return $ret->wrap(__FILE__, __LINE__);
		}
	    }
	}

	foreach (array('_config',
		       '_session',
		       '_profile',
		       '_debugLogFile',
		       '_debugBuffer',
		       '_urlGenerator') as $member) {
	    $gallery->$member = $oldGallery->$member;
	}

	$ret = GalleryInitSecondPass();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	/* For testing purposes, add a couple of local upload dirs */
	$ret = GalleryCoreApi::setPluginParameter('module', 'core', 'uploadLocalServer.dirs',
					    join(',',
						 array('/usr/www/website/menalto.com/albums',
						       '/usr/www/website/menalto.com/dev/gallery/gallery',
						       dirname(dirname(dirname(dirname(__FILE__)))),
						       '/tmp',
						       '/backups')));
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	/* Enable short urls */
	$ret = GalleryCoreApi::setPluginParameter('module', 'core', 'misc.useShortUrls', 'true');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	return GalleryStatus::success();
    }
}
?>
