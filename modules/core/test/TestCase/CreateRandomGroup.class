<?php
/**
 * @version $Revision$ $Date$
 * @package GalleryCore
 * @subpackage TestCase
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * @package GalleryCore
 * @subpackage TestCase
 */
class CreateRandomGroupTestCase extends TestCase {

    function getDescription() {
	return "Create a random group";
    }

    function getIterations() {
	return array(1, 50, 500, 1000, 10000);
    }

    function testStart($iterations) {
	global $gallery;

	$i = 0;
	$collisionCount = 0;
	while ($i < $iterations) {
	    $gallery->guaranteeTimeLimit(5);
	    list ($ret, $group) = GalleryCoreApi::newFactoryInstance('GalleryEntity', 'GalleryGroup');
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }

            if (!isset($group)) {
		return GalleryStatus::error(ERROR_MISSING_OBJECT, __FILE__, __LINE__);
	    }

	    $randSize = 1000000;
	    $rand = rand(1, $randSize);
	    $ret = $group->create('Random ' . $rand);
	    if ($ret->isError()) {
		if ($ret->getErrorCode() & ERROR_COLLISION) {
		    /* This happens */
		    $collisionCount++;
		    if ($collisionCount < $randSize) {
			printf('detected collision #%d (continuing)<br>', $collisionCount);
			continue;
		    }
		}

		return $ret->wrap(__FILE__, __LINE__);
	    }

	    $ret = $group->save();
	    if ($ret->isError()) {
		return $ret->wrap(__FILE__, __LINE__);
	    }
	    $i++;
	}

	return GalleryStatus::success();
    }
}
?>
