<?php

/**
 * @version $Revision$ $Date$
 * @package Comment
 * @subpackage TestCase
 * @author Bharat Mediratta <bharat@menalto.com>
 */

/**
 * @package Comment
 * @subpackage TestCase
 */
class CreateGalleryCommentTestCase extends TestCase {

    function getDescription() {
	return "Create a new comment attached to the root album";
    }

    function testStart() {
	global $gallery;

	list ($ret, $rootAlbumId) =
	    GalleryCoreApi::getPluginParameter('module', 'core', 'id.rootAlbum');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	/* Create the comment */
	list ($ret, $comment) = GalleryCoreApi::newFactoryInstance('GalleryEntity', 'GalleryComment');
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	if (!isset($comment)) {
	    return GalleryStatus::error(ERROR_MISSING_OBJECT, __FILE__, __LINE__);
	}
	
	$ret = $comment->create($rootAlbumId);
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}
	
	/* Make a change */
	$comment->setCommenterId($gallery->getActiveUserId());
	$comment->setComment('Weirdolet writes: "Ananova are reporting that ul'.
			     'tra-dense, pollen sized strangelets (aka nuggets'.
			     'of strange quarks) travelling at 900,000 miles p'.
			     'er hour hit the earth, violently pass through it'.
			     'and have done on at least two occasions already.'.
			     'It\'s also reported, allegedly, in the Sunday te'.
			     'legraph but I haven\'t found it there yet :P Com'.
			     'ing to a particle accelerator near you soon ... '.
			     '?" Another reader has found the story at the Tel'.
			     'egraph.');
	$comment->setDate(time());
	$host = $GLOBALS['HTTP_SERVER_VARS']['REMOTE_HOST'];
	if (empty($host)) {
	    $host = $GLOBALS['HTTP_SERVER_VARS']['REMOTE_ADDR'];
	}
	$comment->setHost($host);

	/* Save the comment */
	$ret = $comment->save();
	if ($ret->isError()) {
	    return $ret->wrap(__FILE__, __LINE__);
	}

	return GalleryStatus::success();
    }
}

?>
